{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_index.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">

    <div class="container"
     data-show-agb-modal="{{ 'true' if show_agb_modal else 'false' }}"
     data-agb-action="{{ agb_action or '' }}">
        <h1>Willkommen</h1>

        <form id="auth-form" method="post"> 
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="input-wrap">
                <input type="text" 
                       name="username" 
                       placeholder="Name" 
                       class="input-field" 
                       required 
                       id="username-field" 
                       maxlength="12"
                       value="{{ pending_registration.username if pending_registration else '' }}">
            </div>
            <div id="username-counter" class="input-hint">0 / 12</div>

            <div class="input-wrap">
                <input
                    type="password"
                    name="password"
                    placeholder="Passwort"
                    class="input-field"
                    required
                    id="password-field">
                <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <div id="password-hint" class="input-hint">Min. 5 Zeichen</div>

            <input type="button" value="Anmelden" class="btn btn-login sound-button" onclick="submitForm('login')" id="login-btn">
            <input type="button" value="Account erstellen" class="btn btn-register sound-button" onclick="prepareRegister()" id="register-btn">
        </form>

        <div class="legal-button-container">
            <a href="{{ url_for('legal') }}" class="legal-button sound-button" aria-label="Rechtliche Informationen">
                <i class="fa-solid fa-section"></i>
            </a>
        </div>
    </div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="popup-container">
            <h2 class="popup-title">AGB & Datenschutz</h2>

            <div class="settings-list">
                <div class="setting-item">
                    <button class="setting-toggle">ðŸ§¾ AGB <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'agb_content.html' %}
                    </div>
                </div>

                <div class="setting-item">
                    <button class="setting-toggle">ðŸ”’ DatenschutzerklÃ¤rung <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'privacy_content.html' %}
                    </div>
                </div>
            </div>

            <div class="acceptance-section">
                <label class="checkbox-container">
                    <input type="checkbox" id="accept-checkbox"> Ich akzeptiere die AGB & DatenschutzerklÃ¤rung
                </label>
            </div>
            

            <div class="popup-buttons">
                <button id="accept-btn" class="popbtn btn-accept" disabled>Akzeptieren</button>
                <button id="reject-btn" class="popbtn btn-reject">Ablehnen</button>
            </div>
            <div class="agb-hint">
                <p>AGB und Datenschutz jederzeit unter <strong>"Rechtliche Informationen"</strong> nachlesbar.</p>
            </div>
        </div>
    </div>
</div>

<script>
    function submitForm(action) {
        try { playSound('clickSound'); } catch(e){}
        const form = document.getElementById('auth-form');
        if (!form) return;
        form.method = 'post';
        if (action === 'register') form.action = "{{ url_for('register') }}";
        else form.action = "{{ url_for('login') }}";
        form.submit();
    }

    function showAgbModal(action) {
        const overlay = document.getElementById('popup-overlay');
        if (!overlay) return;
        overlay.style.display = 'flex';
        overlay.dataset.action = action || '';
    }

    function hideAgbModal() {
        const overlay = document.getElementById('popup-overlay');
        if (!overlay) return;
        overlay.style.display = 'none';
    }

    function handleAgbResponse(accepted) {
        const overlay = document.getElementById('popup-overlay');
        const action = overlay?.dataset.action || '';
        if (accepted) {
            if (action === 'register') {
                const form = document.getElementById('auth-form');
                if (!form) return;
                const agbInput = document.createElement('input');
                agbInput.type = 'hidden'; agbInput.name = 'agb_accepted'; agbInput.value = 'true';
                form.appendChild(agbInput);
                form.action = "{{ url_for('register') }}";
                form.method = 'post';
                form.submit();
            } else {
                const f = document.createElement('form');
                f.method = 'post'; f.action = "{{ url_for('accept_agb') }}";
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden'; csrfToken.name = 'csrf_token'; csrfToken.value = "{{ csrf_token() }}";
                f.appendChild(csrfToken);
                document.body.appendChild(f);
                f.submit();
            }
        } else {
            hideAgbModal();
            const msg = (action === 'register')
                ? 'Um sich zu registrieren, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.'
                : 'Um sich anzumelden, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.';
            (typeof createFlashMessage === 'function') ? createFlashMessage(msg, 'error') : alert(msg);
        }
    }

    async function isUsernameAvailable(username) {
        const url = "{{ url_for('check_username') }}?username=" + encodeURIComponent(username);
        try {
            const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
            if (!resp.ok) return { available: false, message: 'Serverfehler beim PrÃ¼fen des Benutzernamens.' };
            return await resp.json();
        } catch (e) {
            return { available: false, message: 'Netzwerkfehler beim PrÃ¼fen des Benutzernamens.' };
        }
    }

    async function prepareRegister() {
        try { playSound('clickSound'); } catch(e){}
        const usernameField = document.getElementById('username-field');
        const passwordField = document.getElementById('password-field');
        const username = usernameField?.value.trim() || '';
        const password = passwordField?.value || '';

        if (!username || !password) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Um einen Account anzulegen bitte Name und Passwort wÃ¤hlen!', 'error') : alert('Um einen Account anzulegen bitte Name und Passwort wÃ¤hlen!');
            return;
        }
        if (username.length > 12) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Benutzername darf maximal 12 Zeichen haben!', 'error') : alert('Benutzername darf maximal 12 Zeichen haben!');
            return;
        }
        if (password.length < 5) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Passwort muss mindestens 5 Zeichen haben!', 'error') : alert('Passwort muss mindestens 5 Zeichen haben!');
            return;
        }

        const registerBtn = document.getElementById('register-btn');
        if (registerBtn) registerBtn.disabled = true;
        const result = await isUsernameAvailable(username);
        if (registerBtn) registerBtn.disabled = false;

        if (!result.available) {
            const msg = result.message || 'Benutzername bereits vergeben.';
            (typeof createFlashMessage === 'function') ? createFlashMessage(msg, 'error') : alert(msg);
            usernameField?.focus();
            return;
        }
        showAgbModal('register');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const usernameField = document.getElementById('username-field');
        const pwField = document.getElementById('password-field'); // Definition hierher verschoben

        if (usernameField && pwField) {
            usernameField.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Standard-Formularabsendung verhindern
                    pwField.focus();
                    
                    // Setzt den Cursor an das Ende des Passwort-Textes
                    setTimeout(() => {
                        try { 
                            const pos = pwField.value.length; 
                            pwField.setSelectionRange(pos, pos); 
                        } catch(err) {}
                    }, 0);
                }
            });

            pwField.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Standard-Formularabsendung verhindern
                    submitForm('login'); // Anmeldefunktion aufrufen
                }
            });
        }

        const usernameCounter = document.getElementById('username-counter');
        
        function updateUsernameUI() {
            if (!usernameField || !usernameCounter) return;
            const len = usernameField.value.length;
            const max = usernameField.getAttribute('maxlength') || 12;
            
            usernameCounter.textContent = `${len} / ${max}`;
            
            if (len >= max) {
                usernameCounter.classList.add('limit-reached');
            } else {
                usernameCounter.classList.remove('limit-reached');
            }
        }

        if (usernameField) {
            usernameField.addEventListener('input', updateUsernameUI);
            // Initial aufrufen, falls Browser Daten vorausgefÃ¼llt hat
            updateUsernameUI();
        }

        const passwordHint = document.getElementById('password-hint');
        
        function updatePasswordUI() {
            if (!pwField || !passwordHint) return;
            const len = pwField.value.length;
            const min = 5;

            if (len === 0) {
                // Leer: Standard Text
                passwordHint.textContent = `Min. ${min} Zeichen`;
                passwordHint.classList.remove('requirement-met');
                passwordHint.style.color = ''; // Reset
            } else if (len < min) {
                // Zu kurz: Zeige wie viele noch fehlen (optional) oder bleibe bei Standard
                passwordHint.textContent = `Noch ${min - len} Zeichen...`;
                passwordHint.classList.remove('requirement-met');
                passwordHint.style.color = ''; // Standard Grau
            } else {
                // ErfÃ¼llt: GrÃ¼ner Haken oder Text
                passwordHint.innerHTML = '<i class="fa-solid fa-check"></i> GÃ¼ltig';
                passwordHint.classList.add('requirement-met');
            }
        }

        if (pwField) {
            pwField.addEventListener('input', updatePasswordUI);
            updatePasswordUI();
        }

        const pwToggle = document.querySelector('.pw-toggle');
        if (pwField && pwToggle) { // pwField ist jetzt hier bereits definiert
            pwToggle.addEventListener('mousedown', e => e.preventDefault());
            pwToggle.addEventListener('click', () => {
                const isHidden = pwField.type === 'password';
                pwField.type = isHidden ? 'text' : 'password';
                pwToggle.setAttribute('aria-pressed', String(isHidden));
                const icon = pwToggle.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-eye', 'fa-eye-slash');
                    icon.classList.add(isHidden ? 'fa-eye-slash' : 'fa-eye');
                }
                pwField.focus();
                setTimeout(() => {
                    try { const pos = pwField.value.length; pwField.setSelectionRange(pos,pos); } catch(e){}
                }, 0);
            });
        }

        const container = document.querySelector('.container');
        const shouldShowAgbModal = container?.getAttribute('data-show-agb-modal') === 'true';
        const agbAction = container?.getAttribute('data-agb-action');
        if (shouldShowAgbModal) showAgbModal(agbAction || 'login');

        const acceptCheckbox = document.getElementById('accept-checkbox');
        const acceptBtn = document.getElementById('accept-btn');
        const rejectBtn = document.getElementById('reject-btn');
        if (acceptCheckbox && acceptBtn && rejectBtn) {
            acceptCheckbox.addEventListener('change', function() { acceptBtn.disabled = !this.checked; });
            acceptBtn.addEventListener('click', () => { if (acceptCheckbox.checked) handleAgbResponse(true); });
            rejectBtn.addEventListener('click', () => handleAgbResponse(false));
        }

        const toggles = document.querySelectorAll('.setting-toggle');
        toggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const isOpen = content.classList.contains('open');

                if (isOpen) {
                    document.body.classList.remove('agb-modal-open');
                } else {
                    document.body.classList.add('agb-modal-open');
                }

                document.querySelectorAll('.setting-content.open').forEach(c => {
                    if (c !== content) {
                        c.classList.remove('open');
                        c.style.overflowY = 'hidden';
                        const otherIcon = c.previousElementSibling.querySelector('i');
                        if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                    }
                });

                if (isOpen) {
                    content.classList.remove('open');
                    const icon = this.querySelector('i');
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('open');
                    const icon = this.querySelector('i');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                }
            });
        });

        document.querySelectorAll('.setting-content').forEach(c => {
            c.classList.remove('open');
        });
    });
</script>


{% endblock %}