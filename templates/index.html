{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_index.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}    
    <div class="container"
     data-show-agb-modal="{{ 'true' if show_agb_modal else 'false' }}"
     data-agb-action="{{ agb_action or '' }}">
        <h1>Willkommen</h1>

        <form id="auth-form" method="post"> 
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" 
                   name="username" 
                   placeholder="Username" 
                   class="input-field" 
                   required 
                   id="username-field" 
                   value="{{ pending_registration.username if pending_registration else '' }}">
            <div class="input-wrap">
                <input
                    type="password"
                    name="password"
                    placeholder="Password"
                    class="input-field"
                    required
                    id="password-field">
                <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <input type="button" value="Einloggen" class="btn btn-login sound-button" onclick="submitForm('login')" id="login-btn">
            <input type="button" value="Account erstellen" class="btn btn-register sound-button" onclick="prepareRegister()" id="register-btn">
        </form>

        <!-- Neue Button-Gruppe -->
        <div class="extra-buttons">
            <a href="{{ url_for('settings') }}" class="round-button sound-button" aria-label="Einstellungen">
                <i class="fas fa-cog"></i>
            </a>
            <a href="{{ url_for('legal') }}" class="round-button sound-button" aria-label="Rechtliche Informationen">
                <i class="fas fa-scale-balanced"></i>
            </a>
        </div>
    </div>

    <!-- ================= POPUP ================= -->
    <div class="popup-overlay" id="popup-overlay" style="display:none;">
        <div class="popup-container">
            <h2 class="popup-title">AGB & Datenschutz</h2>

            <div class="settings-list">
                <div class="setting-item">
                    <button class="setting-toggle">ðŸ§¾ AGB <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'agb_content.html' %}
                    </div>
                </div>

                <div class="setting-item">
                    <button class="setting-toggle">ðŸ”’ DatenschutzerklÃ¤rung <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'privacy_content.html' %}
                    </div>
                </div>
            </div>

            <div class="acceptance-section">
                <label class="checkbox-container">
                    <input type="checkbox" id="accept-checkbox"> Ich akzeptiere die AGB & DatenschutzerklÃ¤rung
                </label>
            </div>
            

            <div class="popup-buttons">
                <button id="accept-btn" class="popbtn btn-accept" disabled>Akzeptieren</button>
                <button id="reject-btn" class="popbtn btn-reject">Ablehnen</button>
            </div>
            <div class="agb-hint">
                <p>AGB und Datenschutz jederzeit unter <strong>"Rechtliche Informationen"</strong> nachlesbar.</p>
            </div>
        </div>
    </div>
    <!-- ========================================== -->



<script>
    function submitForm(action) {
        try { playSound('clickSound'); } catch(e){}
        const form = document.getElementById('auth-form');
        if (!form) return;
        form.method = 'post';
        if (action === 'register') form.action = "{{ url_for('register') }}";
        else form.action = "{{ url_for('login') }}";
        form.submit();
    }

    function showAgbModal(action) {
        const overlay = document.getElementById('popup-overlay');
        if (!overlay) return;
        overlay.style.display = 'flex';
        overlay.dataset.action = action || '';
        
        // HÃ¶he sofort beim Ã–ffnen berechnen
        requestAnimationFrame(() => {
            adjustAllOpenContents();
        });
    }

    function hideAgbModal() {
        const overlay = document.getElementById('popup-overlay');
        if (!overlay) return;
        overlay.style.display = 'none';
    }

    function handleAgbResponse(accepted) {
        const overlay = document.getElementById('popup-overlay');
        const action = overlay?.dataset.action || '';
        if (accepted) {
            if (action === 'register') {
                const form = document.getElementById('auth-form');
                if (!form) return;
                const agbInput = document.createElement('input');
                agbInput.type = 'hidden'; agbInput.name = 'agb_accepted'; agbInput.value = 'true';
                form.appendChild(agbInput);
                form.action = "{{ url_for('register') }}";
                form.method = 'post';
                form.submit();
            } else {
                const f = document.createElement('form');
                f.method = 'post'; f.action = "{{ url_for('accept_agb') }}";
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden'; csrfToken.name = 'csrf_token'; csrfToken.value = "{{ csrf_token() }}";
                f.appendChild(csrfToken);
                document.body.appendChild(f);
                f.submit();
            }
        } else {
            hideAgbModal();
            const msg = (action === 'register')
                ? 'Um sich zu registrieren, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.'
                : 'Um sich anzumelden, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.';
            (typeof createFlashMessage === 'function') ? createFlashMessage(msg, 'error') : alert(msg);
        }
    }

    async function isUsernameAvailable(username) {
        const url = "{{ url_for('check_username') }}?username=" + encodeURIComponent(username);
        try {
            const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
            if (!resp.ok) return { available: false, message: 'Serverfehler beim PrÃ¼fen des Benutzernamens.' };
            return await resp.json();
        } catch (e) {
            return { available: false, message: 'Netzwerkfehler beim PrÃ¼fen des Benutzernamens.' };
        }
    }

    async function prepareRegister() {
        try { playSound('clickSound'); } catch(e){}
        const usernameField = document.getElementById('username-field');
        const passwordField = document.getElementById('password-field');
        const username = usernameField?.value.trim() || '';
        const password = passwordField?.value || '';

        if (!username || !password) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Um einen Account anzulegen bitte Usernamen und Passwort wÃ¤hlen!', 'error') : alert('Um einen Account anzulegen bitte Usernamen und Passwort wÃ¤hlen!');
            return;
        }
        if (username.length > 12) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Benutzername darf maximal 12 Zeichen haben', 'error') : alert('Benutzername darf maximal 12 Zeichen haben');
            return;
        }
        if (password.length < 5) {
            (typeof createFlashMessage === 'function') ? createFlashMessage('Passwort muss mindestens 5 Zeichen haben!', 'error') : alert('Passwort muss mindestens 5 Zeichen haben!');
            return;
        }

        const registerBtn = document.getElementById('register-btn');
        if (registerBtn) registerBtn.disabled = true;
        const result = await isUsernameAvailable(username);
        if (registerBtn) registerBtn.disabled = false;

        if (!result.available) {
            const msg = result.message || 'Benutzername bereits vergeben.';
            (typeof createFlashMessage === 'function') ? createFlashMessage(msg, 'error') : alert(msg);
            usernameField?.focus();
            return;
        }
        showAgbModal('register');
    }

    // Adjusts ONE .setting-content height so it fits between title and footer
    function adjustSpecificContentHeight(contentEl) {
        if (!contentEl) return;
        const popup = document.querySelector('.popup-container');
        if (!popup) {
            // fallback: make it scroll the element itself up to viewport
            contentEl.style.maxHeight = Math.min(contentEl.scrollHeight, window.innerHeight * 0.6) + 'px';
            contentEl.style.overflowY = (contentEl.scrollHeight > parseFloat(contentEl.style.maxHeight)) ? 'auto' : 'hidden';
            return;
        }

        // compute available height inside popup
        // total popup inner height:
        const popupStyle = getComputedStyle(popup);
        const popupPaddingTop = parseFloat(popupStyle.paddingTop || 0);
        const popupPaddingBottom = parseFloat(popupStyle.paddingBottom || 0);
        const popupInnerHeight = popup.clientHeight - popupPaddingTop - popupPaddingBottom;

        // heights of elements that must remain visible (title + acceptance + buttons + gaps)
        const title = popup.querySelector('.popup-title');
        const acceptance = popup.querySelector('.acceptance-section');
        const buttons = popup.querySelector('.popup-buttons');

        const titleH = title ? title.offsetHeight : 0;
        const acceptanceH = acceptance ? acceptance.offsetHeight : 0;
        const buttonsH = buttons ? buttons.offsetHeight : 0;

        // calculate space available for settings-list (and thus for individual content)
        // include a small safety-gap (16px)
        const safety = 16;
        const hintH = document.querySelector('.agb-hint') ? document.querySelector('.agb-hint').offsetHeight : 0;
        const availableForList = popupInnerHeight - titleH - acceptanceH - buttonsH - hintH - safety;
        // find the top offset of the content within the settings-list to compute per-item available
        const settingsList = popup.querySelector('.settings-list');
        let availableForThisContent = availableForList;
        if (settingsList) {
            // subtract space taken by other open sibling headers/spacing above this content
            // simpler: we allow the opened content to use up to availableForList (safe)
            // but ensure it's at least 80px
            availableForThisContent = Math.max(80, availableForList);
        }

        const desired = Math.min(contentEl.scrollHeight, availableForThisContent);
        contentEl.style.maxHeight = desired + 'px';
        contentEl.style.overflowY = (contentEl.scrollHeight > desired) ? 'auto' : 'hidden';
    }

    // Adjust all currently open contents (used on resize or show)
    function adjustAllOpenContents() {
        document.querySelectorAll('.setting-content.open').forEach(c => adjustSpecificContentHeight(c));
    }

    document.addEventListener('DOMContentLoaded', function() {
        // password toggle (wie gehabt)
        const pwField = document.getElementById('password-field');
        const pwToggle = document.querySelector('.pw-toggle');
        if (pwField && pwToggle) {
            pwToggle.addEventListener('mousedown', e => e.preventDefault());
            pwToggle.addEventListener('click', () => {
                const isHidden = pwField.type === 'password';
                pwField.type = isHidden ? 'text' : 'password';
                pwToggle.setAttribute('aria-pressed', String(isHidden));
                const icon = pwToggle.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-eye', 'fa-eye-slash');
                    icon.classList.add(isHidden ? 'fa-eye-slash' : 'fa-eye');
                }
                pwField.focus();
                setTimeout(() => {
                    try { const pos = pwField.value.length; pwField.setSelectionRange(pos,pos); } catch(e){}
                }, 0);
            });
        }

        // AGB modal initial show
        const container = document.querySelector('.container');
        const shouldShowAgbModal = container?.getAttribute('data-show-agb-modal') === 'true';
        const agbAction = container?.getAttribute('data-agb-action');
        if (shouldShowAgbModal) showAgbModal(agbAction || 'login');

        // hooks for accept/reject buttons
        const acceptCheckbox = document.getElementById('accept-checkbox');
        const acceptBtn = document.getElementById('accept-btn');
        const rejectBtn = document.getElementById('reject-btn');
        if (acceptCheckbox && acceptBtn && rejectBtn) {
            acceptCheckbox.addEventListener('change', function() { acceptBtn.disabled = !this.checked; });
            acceptBtn.addEventListener('click', () => { if (acceptCheckbox.checked) handleAgbResponse(true); });
            rejectBtn.addEventListener('click', () => handleAgbResponse(false));
        }

        // Accordion logic: only one open; compute available height so footer remains visible
        const toggles = document.querySelectorAll('.setting-toggle');
        toggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const isOpen = content.classList.contains('open');

                if (isOpen) {
                    document.body.classList.remove('agb-modal-open');
                } else {
                    document.body.classList.add('agb-modal-open');
                }

                // close all others
                document.querySelectorAll('.setting-content.open').forEach(c => {
                    if (c !== content) {
                        c.classList.remove('open');
                        c.style.maxHeight = '0px';
                        c.style.overflowY = 'hidden';
                        const otherIcon = c.previousElementSibling.querySelector('i');
                        if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                    }
                });

                if (isOpen) {
                    // close this
                    content.classList.remove('open');
                    content.style.maxHeight = '0px';
                    content.style.overflowY = 'hidden';
                    const icon = this.querySelector('i');
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    // open this
                    content.classList.add('open');
                    const icon = this.querySelector('i');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                    // calculate available height for content so footer stays visible
                    adjustSpecificContentHeight(content);
                }
            });
        });

        // ensure all closed initially
        document.querySelectorAll('.setting-content').forEach(c => {
            c.classList.remove('open');
            c.style.maxHeight = '0px';
            c.style.overflowY = 'hidden';
        });

        // Re-calc when window resized or overlay changes (keeps buttons visible)
        window.addEventListener('resize', adjustAllOpenContents);
        // Optional: when scroll inside overlay/page could change layout, recalc on transitionend as well
        document.getElementById('popup-overlay')?.addEventListener('transitionend', adjustAllOpenContents);
    });
</script>


{% endblock %}