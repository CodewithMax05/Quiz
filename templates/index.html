{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_index.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}    
    <div class="container"
     data-show-agb-modal="{{ 'true' if show_agb_modal else 'false' }}"
     data-agb-action="{{ agb_action or '' }}">
        <h1>Willkommen</h1>

        <form id="auth-form" method="post"> 
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" 
                   name="username" 
                   placeholder="Username" 
                   class="input-field" 
                   required 
                   id="username-field" 
                   value="{{ pending_registration.username if pending_registration else '' }}">
            <div class="input-wrap">
                <input
                    type="password"
                    name="password"
                    placeholder="Password"
                    class="input-field"
                    required
                    id="password-field">
                <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <input type="button" value="Login" class="btn btn-login sound-button" onclick="submitForm('login')" id="login-btn">
            <input type="button" value="Register" class="btn btn-register sound-button" onclick="prepareRegister()" id="register-btn">
        </form>

        <!-- Neue Button-Gruppe -->
        <div class="extra-buttons">
            <a href="{{ url_for('settings') }}" class="round-button sound-button" aria-label="Einstellungen">
                <i class="fas fa-cog"></i>
            </a>
            <a href="{{ url_for('legal') }}" class="round-button sound-button" aria-label="Rechtliches">
                <i class="fas fa-landmark"></i>
            </a>
            <a href="{{ url_for('support') }}" class="round-button sound-button" aria-label="Support">
                <i class="fas fa-headset"></i>
            </a>
        </div>
    </div>

    <!-- ================= POPUP ================= -->
    <div class="popup-overlay" id="popup-overlay" style="display:none;">
        <div class="popup-container">
            <h2 class="popup-title">AGB & Datenschutz</h2>

            <div class="settings-list">
                <div class="setting-item">
                    <button class="setting-toggle">ðŸ§¾ AGB <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'agb_content.html' %}
                    </div>
                </div>

                <div class="setting-item">
                    <button class="setting-toggle">ðŸ”’ DatenschutzerklÃ¤rung <i class="fa fa-chevron-down"></i></button>
                    <div class="setting-content">
                        {% include 'privacy_content.html' %}
                    </div>
                </div>
            </div>

            <div class="acceptance-section">
                <label class="checkbox-container">
                    <input type="checkbox" id="accept-checkbox"> Ich akzeptiere die AGB und DatenschutzerklÃ¤rung
                </label>
            </div>

            <div class="popup-buttons">
                <button id="accept-btn" class="popbtn btn-accept" disabled>Akzeptieren</button>
                <button id="reject-btn" class="popbtn btn-reject">Ablehnen</button>
            </div>
        </div>
    </div>
    <!-- ========================================== -->

    <script>
        function submitForm(action) {
            playSound('clickSound');
            
            if (action === 'register') {
                const form = document.getElementById('auth-form');
                form.action = "{{ url_for('register') }}";
                form.method = "post";
                form.submit();
            } else if (action === 'login') {
                // FÃ¼r Login das Formular direkt abschicken
                // Das Backend entscheidet ob Modal nÃ¶tig ist
                const form = document.getElementById('auth-form');
                form.action = "{{ url_for('login') }}";
                form.method = "post";
                form.submit();
            }
        }

        function showAgbModal(action) {
            document.getElementById('popup-overlay').style.display = 'flex';
            // Speichere die Aktion fÃ¼r spÃ¤ter
            document.getElementById('popup-overlay').dataset.action = action;
        }

        function handleAgbResponse(accepted) {
            const action = document.getElementById('popup-overlay').dataset.action;
            
            if (accepted) {
                if (action === 'register') {
                    // FÃ¼r Registrierung: Formular mit AGB-Flag abschicken
                    const form = document.getElementById('auth-form');
                    let agbInput = document.createElement('input');
                    agbInput.type = 'hidden';
                    agbInput.name = 'agb_accepted';
                    agbInput.value = 'true';
                    form.appendChild(agbInput);
                    form.action = "{{ url_for('register') }}";
                    form.method = "post";
                    form.submit();
                } else if (action === 'login') {
                    // FÃ¼r Login: Spezielle Route fÃ¼r AGB-Akzeptierung aufrufen
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = "{{ url_for('accept_agb') }}";
                    
                    // CSRF Token hinzufÃ¼gen
                    const csrfToken = document.createElement('input');
                    csrfToken.type = 'hidden';
                    csrfToken.name = 'csrf_token';
                    csrfToken.value = "{{ csrf_token() }}";
                    form.appendChild(csrfToken);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            } else {
                // Wenn abgelehnt, Flash-Nachricht anzeigen und Modal schlieÃŸen
                document.getElementById('popup-overlay').style.display = 'none';
                
                if (action === 'register') {
                    createFlashMessage('Um sich zu registrieren, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.', 'error');
                } else {
                    createFlashMessage('Um sich anzumelden, mÃ¼ssen Sie den AGB und der DatenschutzerklÃ¤rung zustimmen.', 'error');
                }
            }
        }

        async function isUsernameAvailable(username) {
            // ruft serverseitigen Endpoint ab, der JSON {available: true/false, message?: "..."} liefert
            const url = "{{ url_for('check_username') }}?username=" + encodeURIComponent(username);
            try {
                const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
                if (!resp.ok) {
                    // Bei Netzwerk-/Serverfehlern lieber den Nutzer informieren
                    return { available: false, message: 'Serverfehler beim PrÃ¼fen des Benutzernamens.' };
                }
                return await resp.json();
            } catch (err) {
                return { available: false, message: 'Netzwerkfehler beim PrÃ¼fen des Benutzernamens.' };
            }
        }

        async function prepareRegister() {
            playSound && playSound('clickSound');

            const usernameField = document.getElementById('username-field');
            const passwordField = document.getElementById('password-field');

            const username = usernameField ? usernameField.value.trim() : '';
            const password = passwordField ? passwordField.value : '';

            // Clientseitige Grundvalidierung
            if (!username || !password) {
                (typeof createFlashMessage === 'function') ?
                    createFlashMessage('Bitte fÃ¼lle alle Felder aus', 'error') :
                    alert('Bitte fÃ¼lle alle Felder aus');
                return;
            }
            if (username.length > 12) {
                (typeof createFlashMessage === 'function') ?
                    createFlashMessage('Benutzername darf maximal 12 Zeichen haben', 'error') :
                    alert('Benutzername darf maximal 12 Zeichen haben');
                return;
            }
            if (password.length < 5) {
                (typeof createFlashMessage === 'function') ?
                    createFlashMessage('Passwort muss mindestens 5 Zeichen haben!', 'error') :
                    alert('Passwort muss mindestens 5 Zeichen haben!');
                return;
            }

            // Disable Button wÃ¤hrend PrÃ¼fung (UX)
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) registerBtn.disabled = true;

            const result = await isUsernameAvailable(username);

            if (registerBtn) registerBtn.disabled = false;

            if (!result.available) {
                // Benutzername belegt â€” Modal nicht Ã¶ffnen
                if (result.message) {
                    (typeof createFlashMessage === 'function') ?
                        createFlashMessage(result.message, 'error') :
                        alert(result.message);
                } else {
                    (typeof createFlashMessage === 'function') ?
                        createFlashMessage('Benutzername bereits vergeben.', 'error') :
                        alert('Benutzername bereits vergeben.');
                }
                // optional: fokus auf username feld
                if (usernameField) usernameField.focus();
                return;
            }

            // alles ok -> Modal Ã¶ffnen wie gehabt
            showAgbModal('register');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // --- Passwort Toggle ---
            const pwField = document.getElementById('password-field');
            const pwToggle = document.querySelector('.pw-toggle');

            if (pwField && pwToggle) {
                pwToggle.addEventListener('mousedown', function(e){ e.preventDefault(); });
                pwToggle.addEventListener('click', function (e) {
                    const isHidden = pwField.type === 'password';
                    pwField.type = isHidden ? 'text' : 'password';
                    pwToggle.setAttribute('aria-pressed', String(isHidden));
                    const icon = pwToggle.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye', 'fa-eye-slash');
                        icon.classList.add(isHidden ? 'fa-eye-slash' : 'fa-eye');
                    }
                    pwField.focus();
                    setTimeout(() => {
                        try {
                            const pos = pwField.value ? pwField.value.length : 0;
                            pwField.setSelectionRange(pos, pos);
                        } catch (err) {}
                    }, 0);
                });
            }

            // --- AGB Modal Logik ---
            const acceptCheckbox = document.getElementById('accept-checkbox');
            const acceptBtn = document.getElementById('accept-btn');
            const rejectBtn = document.getElementById('reject-btn');
            const popupOverlay = document.getElementById('popup-overlay');

            // PrÃ¼fe ob Modal beim Laden angezeigt werden soll (fÃ¼r Login-FÃ¤lle)
            const container = document.querySelector('.container');
            const shouldShowAgbModal = container && container.getAttribute('data-show-agb-modal') === 'true';
            const agbAction = container && container.getAttribute('data-agb-action');
            
            if (shouldShowAgbModal) {
                showAgbModal(agbAction ? agbAction : 'login');
            }

            if (acceptCheckbox && acceptBtn) {
                acceptCheckbox.addEventListener('change', function() {
                    acceptBtn.disabled = !this.checked;
                });

                acceptBtn.addEventListener('click', function() {
                    if (acceptCheckbox.checked) {
                        handleAgbResponse(true);
                    }
                });

                rejectBtn.addEventListener('click', function() {
                    handleAgbResponse(false);
                });
            }

            // --- Accordion Logik fÃ¼r AGB Inhalte ---
            const accordionToggles = document.querySelectorAll('.setting-toggle');
            accordionToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('i');
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                    
                    // SchlieÃŸe alle anderen
                    document.querySelectorAll('.setting-content').forEach(item => {
                        if (item !== content) {
                            item.style.maxHeight = '0px';
                            const otherIcon = item.previousElementSibling.querySelector('i');
                            if (otherIcon) {
                                otherIcon.style.transform = 'rotate(0deg)';
                            }
                        }
                    });

                    // Ã–ffne/SchlieÃŸe aktuelles
                    if (isOpen) {
                        content.style.maxHeight = '0px';
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        if (icon) {
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                });
            });

            // Initialisiere Accordions als geschlossen
            document.querySelectorAll('.setting-content').forEach(content => {
                content.style.maxHeight = '0px';
            });
        });
    </script>
{% endblock %}