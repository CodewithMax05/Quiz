{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_evaluate.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}    
    <div class="evaluate-container">
        <!-- Header mit Avatar und Benutzername -->
        <div class="user-header">
            <div class="avatar-section">
                <img src="{{ url_for('static', filename='pictures/avatar/' + user_avatar) }}" 
                     alt="Avatar" 
                     class="user-avatar-large">
                <div class="user-info">
                    <h2 class="username">{{ session.username }}</h2>
                    <div class="quiz-completion">Quiz abgeschlossen!</div>
                </div>
            </div>
        </div>

        <!-- Haupt-Ergebnisbereich -->
        <div class="results-main">
            <div class="score-section">
                <div class="score-circle" id="scoreCircle" data-score="{{ score }}" data-total="{{ total }}">
                    <div class="circle-glass"></div>

                    <!-- Wasser-Layer: Füllung, Wellen, Blasen -->
                    <div class="water-layer" aria-hidden="true">
                        <div class="waves">
                            <div class="wave wave1"></div>
                            <div class="wave wave2"></div>
                        </div>

                        <!-- bubble container: wird dynamisch mittels JS befüllt -->
                        <div class="bubbles" aria-hidden="true"></div>
                    </div>

                    <div class="score-content">
                        <div class="score-number">{{ score }}</div>
                        <div class="score-label">Punkte</div>
                    </div>
                </div>
                
                <div class="correct-answers">
                    <div class="correct-count">
                        <span class="correct-number">{{ correct_answers }}</span>
                        <span class="correct-text">richtig</span>
                    </div>
                    <div class="total-questions">
                        von {{ total }} Fragen
                    </div>
                </div>
            </div>

            <!-- Performance-Bewertung -->
            <div class="performance-rating">
                {% if correct_answers == total %}
                    <div class="rating perfect">
                        <i class="fas fa-trophy rating-icon"></i>
                        <div class="rating-content">
                            <h3>Perfektes Ergebnis!</h3>
                            <p>Alle Fragen richtig beantwortet - herausragende Leistung!</p>
                        </div>
                    </div>
                {% elif correct_answers >= total * 0.8 %}
                    <div class="rating excellent">
                        <i class="fas fa-star rating-icon"></i>
                        <div class="rating-content">
                            <h3>Großartige Leistung!</h3>
                            <p>Du bist auf dem besten Weg zum Quiz-Meister!</p>
                        </div>
                    </div>
                {% elif correct_answers >= total * 0.65 %}
                    <div class="rating good">
                        <i class="fas fa-thumbs-up rating-icon"></i>
                        <div class="rating-content">
                            <h3>Gute Arbeit!</h3>
                            <p>Solides Wissen - nur noch wenige Lücken!</p>
                        </div>
                    </div>
                {% elif correct_answers >= total * 0.5 %}
                    <div class="rating average">
                        <i class="fas fa-rocket rating-icon"></i>
                        <div class="rating-content">
                            <h3>Weiter so!</h3>
                            <p>Die Hälfte geschafft - mit etwas Übung schaffst du mehr!</p>
                        </div>
                    </div>
                {% else %}
                    <div class="rating improve">
                        <i class="fas fa-book rating-icon"></i>
                        <div class="rating-content">
                            <h3>Lernzeit!</h3>
                            <p>Nutze die Chance, dein Wissen zu erweitern!</p>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Highscore-Information -->
            <div class="highscore-section">
                {% if new_highscore %}
                    <div class="new-highscore-badge">
                        <i class="fas fa-crown"></i>
                        <span>Neuer Rekord: {{ score }} Punkte!</span>
                    </div>
                {% else %}
                    <div class="current-highscore">
                        <i class="fas fa-chart-line"></i>
                        <span>Dein Highscore: <strong>{{ highscore }}</strong> Punkte</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Aktions-Buttons -->
        <div class="action-buttons">
            <a href="{{ url_for('ranking') }}" class="btn ranking-btn sound-button">
                <i class="fas fa-trophy"></i>
                Ranking
            </a>
            <a href="{{ url_for('homepage') }}" class="btn home-btn sound-button">
                <i class="fas fa-home"></i>
                Zurück zur Startseite
            </a>
        </div>
    </div>

    <script>
        try { sessionStorage.removeItem('quiz_active'); } catch (e) { console.warn(e); }

        document.addEventListener('DOMContentLoaded', function () {
        const scoreCircle = document.getElementById('scoreCircle');
        if (!scoreCircle) return;

        const score = parseInt(scoreCircle.dataset.score || '0', 10);
        const total = parseInt(scoreCircle.dataset.total || '1', 10);
        const maxScore = total * 100;
        const fillPercentage = Math.max(0, Math.min((score / maxScore) * 100, 100));

        // setze CSS-Variable für Füllhöhe falls benötigt
        scoreCircle.style.setProperty('--fill-height', fillPercentage + '%');

        // warte kurz, damit Layout gemessen werden kann
        setTimeout(() => {
            scoreCircle.classList.add('animate-fill');
            if (fillPercentage > 5) scoreCircle.classList.add('has-waves');

            const bubblesContainer = scoreCircle.querySelector('.bubbles');
            bubblesContainer.innerHTML = '';

            if (score >= 400) {
            scoreCircle.classList.add('has-bubbles');

            // Anzahl Blasen skalierend mit Score
            const bubbleCount = Math.min(24, Math.max(6, Math.round(score / 200)));

            // exakte Kreis-Höhe in px (Layout-sicher)
            const circleRect = scoreCircle.getBoundingClientRect();
            const circleHeightPx = circleRect.height || 200;

            const globalMinPeak = 4; // in % of circle height, minimale Aufstiegsmöglichkeit

            for (let i = 0; i < bubbleCount; i++) {
                const b = document.createElement('span');
                b.className = 'bubble';

                // zufällige Größe in px
                const size = Math.round(6 + Math.random() * 12);
                b.style.width = size + 'px';
                b.style.height = size + 'px';

                // horizontale Position
                const left = (5 + Math.random() * 90).toFixed(2);
                b.style.left = left + '%';

                // Verzögerung und Dauer
                const delay = (Math.random() * 6).toFixed(2) + 's';
                const duration = (3.2 + Math.random() * 4.0).toFixed(2) + 's';

                // Größe der Blase in Prozent der Kreis-Höhe
                const sizePercent = (size / circleHeightPx) * 100;

                //seitliche Bewegung
                const wobblePx = ((Math.random() - 0.5) * 12).toFixed(2) + 'px'; // seitliche Verschiebung ±6px
                const scale = (0.86 + Math.random() * 0.26).toFixed(2); // Skala 0.86 - 1.12

                b.style.setProperty('--bubble-wobble', wobblePx);
                b.style.setProperty('--bubble-scale', scale);

                // berechne maxAllowed in % (fillPercentage minus Blasengröße minus Sicherheitsabstand)
                let maxAllowed = fillPercentage - sizePercent - 1;
                if (!isFinite(maxAllowed)) maxAllowed = globalMinPeak;
                if (maxAllowed < globalMinPeak) maxAllowed = globalMinPeak;
                if (maxAllowed > 92) maxAllowed = 92;

                // zufälliger Peak in % zwischen globalMinPeak und maxAllowed
                const peakPercent = (globalMinPeak + Math.random() * (maxAllowed - globalMinPeak));

                // Wandle Peak% in px um und setze CSS-Variable in px
                const peakPx = (peakPercent / 100) * circleHeightPx;
                b.style.setProperty('--bubble-peak-px', Math.round(peakPx) + 'px');

                // Setze sonstige Animations-Variablen
                b.style.setProperty('--bubble-delay', delay);
                b.style.setProperty('--bubble-duration', duration);
                b.style.animationDelay = delay;
                b.style.animationDuration = duration;

                bubblesContainer.appendChild(b);
            }

            } else {
            scoreCircle.classList.remove('has-bubbles');
            }
        }, 80); // kurzer Timeout, damit Layoutgrößen verfügbar sind
        });
        </script>
{% endblock %}
