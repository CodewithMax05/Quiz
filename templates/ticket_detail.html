{% extends "base.html" %}

{% block head %}
    <title>Ticket #{{ ticket.id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_ticket_detail.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="container">
        
        <h1 class="support-title">{{ ticket.subject }}</h1>

        <div class="controls-row">
            <div class="controls-left">
                <a href="{{ url_for('tickets_overview') }}" class="back-button sound-button">
                    <i class="fas fa-chevron-left"></i> <span class="btn-text">Zurück</span>
                </a>
            </div>

            <div class="controls-center">
                {% if ticket.status == 'open' %}
                    <span class="status-badge status-open"><i class="fas fa-lock-open"></i> Offen</span>
                {% else %}
                    <span class="status-badge status-closed"><i class="fas fa-lock"></i> Geschlossen</span>
                {% endif %}
            </div>

            <div class="controls-right">
                <form method="POST" action="{{ url_for('toggle_ticket_status', ticket_id=ticket.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if ticket.status == 'open' %}
                    <button type="submit" class="action-button btn-toggle sound-button" title="Ticket schließen">
                        <i class="fas fa-check-circle"></i> <span class="btn-text">Schließen</span>
                    </button>
                    {% else %}
                    <button type="submit" class="action-button btn-toggle sound-button" title="Ticket wieder öffnen">
                        <i class="fas fa-undo"></i> <span class="btn-text">Öffnen</span>
                    </button>
                    {% endif %}
                </form>

                {% if is_admin and ticket.status == 'closed' %}
                <form method="POST" action="{{ url_for('admin_delete_ticket', ticket_id=ticket.id) }}" onsubmit="return confirm('Möchten Sie dieses Ticket wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="action-button btn-delete sound-button" title="Ticket löschen">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="ticket-meta-row">
            <span class="meta-item"><i class="fas fa-tag"></i> {{ ticket.category }}</span>
            <span class="meta-item"><i class="fas fa-user"></i> {{ ticket.user.username }}</span>
            <span class="meta-item">
                <i class="far fa-clock"></i>
                <time class="utc-time" data-iso="{{ ticket.created_at|to_iso }}">
                    {{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}
                </time>
            </span>
        </div>

        <div class="chat-scroll-wrapper" id="chat-container">
            <div id="chat-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Lade ältere Nachrichten...
            </div>

            {% for message in messages %}
                <div class="message {{ 'admin-message' if message.sender_type == 'admin' else 'user-message' }}">
                    <div class="message-header">
                        <span class="sender-name">
                            {% if message.sender_type == 'admin' %}Support{% else %}{{ message.sender_name }}{% endif %}
                        </span>
                        <span class="message-time">
                            <time class="utc-time" data-iso="{{ message.created_at|to_iso }}">
                                {{ message.created_at.strftime('%H:%M') }}
                            </time>
                        </span>
                    </div>
                    <p class="message-content">{{ message.content }}</p>
                </div>
            {% endfor %}
        </div>

        <div class="input-area-wrapper">
            {% if ticket.status == 'open' %}
                <form class="chat-form" method="POST" action="{{ url_for('ticket_detail', ticket_id=ticket.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <textarea name="message_content" class="chat-textarea" 
                              maxlength="500" placeholder="Schreibe eine Nachricht..." required 
                              oninput="updateCharCount(this, 'counter-chat')"></textarea>
                    
                    <div class="input-actions">
                        <span id="counter-chat" class="char-counter">0 / 500</span>
                        <button type="submit" class="send-button sound-button">
                            <i class="fas fa-paper-plane"></i> Senden
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="closed-notice">
                    <i class="fas fa-lock"></i> Dieses Ticket ist geschlossen.
                </div>
            {% endif %}
        </div>

    </div>
</div>

<script>
    function updateCharCount(textarea, counterId) {
        const maxLength = 500;
        const currentLength = textarea.value.length;
        const counter = document.getElementById(counterId);
        counter.textContent = `${currentLength} / ${maxLength}`;
        
        if (currentLength >= maxLength) {
            counter.style.color = '#fc8181';
        } else {
            counter.style.color = '#aaa';
        }
    }

    // --- CHAT LOGIK: Paging & Scrolling ---
    document.addEventListener("DOMContentLoaded", function() {
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('chat-loading');
        const ticketId = "{{ ticket.id }}";
        
        let currentOffset = 20; 
        let isLoading = false;
        let hasMore = true; 

        // 1. Initial ganz nach unten scrollen
        scrollToBottom();

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 2. Event Listener für das Scrollen nach oben
        chatContainer.addEventListener('scroll', function() {
            if (chatContainer.scrollTop === 0 && !isLoading && hasMore) {
                loadOlderMessages();
            }
        });

        async function loadOlderMessages() {
            isLoading = true;
            loadingIndicator.style.display = 'block';

            const oldHeight = chatContainer.scrollHeight;

            try {
                const response = await fetch(`/api/ticket/${ticketId}/messages?offset=${currentOffset}`);
                if (!response.ok) throw new Error('Netzwerkfehler');
                
                const data = await response.json();
                
                if (data.messages && data.messages.length > 0) {
                    prependMessages(data.messages);
                    currentOffset += data.messages.length;
                    hasMore = data.has_more;

                    requestAnimationFrame(() => {
                        const newHeight = chatContainer.scrollHeight;
                        chatContainer.scrollTop = newHeight - oldHeight;
                    });
                } else {
                    hasMore = false;
                }

            } catch (error) {
                console.error("Fehler beim Laden:", error);
            } finally {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }

        function prependMessages(messages) {
            let html = '';
            messages.forEach(msg => {
                const isSupport = (msg.sender_type === 'admin');
                const cssClass = isSupport ? 'admin-message' : 'user-message';
                const senderDisplay = isSupport ? 'Support' : msg.sender_name;
                
                html += `
                <div class="message ${cssClass}">
                    <div class="message-header">
                        <span class="sender-name">${escapeHtml(senderDisplay)}</span>
                        <span class="message-time">
                            <time class="utc-time-done">${msg.created_at_formatted}</time>
                        </span>
                    </div>
                    <p class="message-content">${escapeHtml(msg.content)}</p>
                </div>
                `;
            });
            
            loadingIndicator.insertAdjacentHTML('afterend', html);
        }
        
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    });
</script>
{% endblock %}