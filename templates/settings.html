{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_settings.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="container">
        <h1 class="headline">Einstellungen</h1>

        <div class="settings-list">
            <!-- Benutzername √§ndern -->
            <div class="setting-item">
                <button class="setting-toggle">Username √§ndern <i class="fa fa-chevron-down"></i></button>
                <div class="setting-content">
                    <form id="username-form" method="POST" action="{{ url_for('change_username') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="text" name="current_username" placeholder="Aktueller Benutzername" value="" required>
                        <input type="text" name="new_username" placeholder="Neuer Benutzername" value="" required>
                        <div class="input-wrap">
                            <input type="password" name="password" placeholder="Passwort" value="" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit">Speichern</button>
                    </form>
                </div>
            </div>

            <!-- Passwort √§ndern -->
            <div class="setting-item">
                <button class="setting-toggle">Passwort √§ndern <i class="fa fa-chevron-down"></i></button>
                <div class="setting-content">
                    <form id="password-form" method="POST" action="{{ url_for('change_password') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <input type="text" name="username" placeholder="Aktueller Benutzername" value="" required>
                        
                        <div class="input-wrap">
                            <input type="password" name="current_password" placeholder="Aktuelles Passwort" value="" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        
                        <div class="input-wrap">
                            <input type="password" name="new_password" placeholder="Neues Passwort" value="" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        
                        <div class="input-wrap">
                            <input type="password" name="confirm_password" placeholder="Neues Passwort best√§tigen" value="" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        
                        <button type="submit">Speichern</button>
                    </form>
                </div>
            </div>

            <!-- Avatar √§ndern -->
            <div class="setting-item">
                <button class="setting-toggle">Avatar √§ndern <i class="fa fa-chevron-down"></i></button>
                <div class="setting-content">
                    <form id="avatar-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                       <!-- Eingabefelder f√ºr Benutzername und Passwort - JETZT MIT TOGGLE -->
                        <input type="text" id="avatar-username" name="username" placeholder="Benutzername" value="" required>
                        
                        <div class="input-wrap">
                            <input type="password" id="avatar-password" name="password" placeholder="Passwort" value="" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        
                        <!-- Avatar Auswahl Bereich -->
                        <div class="avatar-selection-container">
                            <h4 style="color: white; margin-bottom: 15px; text-align: center;">W√§hle einen Avatar:</h4>
                            
                            <!-- Karussell Container - WIE IN PLAYERMENU -->
                            <div class="carousel-container">
                                <button type="button" class="carousel-button prev-button" id="settings-prev-avatar">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                
                                <div class="avatar-carousel">
                                    <div class="carousel-track" id="settings-carousel-track">
                                        <!-- Avatare werden hier dynamisch geladen -->
                                    </div>
                                </div>
                                
                                <button type="button" class="carousel-button next-button" id="settings-next-avatar">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            
                            <div class="carousel-indicator">
                                <span id="settings-current-index">1</span> / <span id="settings-total-avatars">26</span>
                            </div>
                        </div>

                        <button type="button" id="save-avatar-btn" class="save-avatar-button">Avatar speichern</button>
                    </form>
                </div>
            </div>

            <!-- Account l√∂schen -->
            <div class="setting-item">
                <button class="setting-toggle">Account l√∂schen <i class="fa fa-chevron-down"></i></button>
                <div class="setting-content">
                    <form id="delete-account-form" method="POST" action="{{ url_for('delete_account') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="text" name="username" placeholder="Benutzername" value="" required>
                        
                        <div class="input-wrap">
                            <input type="password" name="password" placeholder="Passwort" required>
                            <button type="button" class="pw-toggle" aria-label="Passwort anzeigen" aria-pressed="false">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>

                        <p style="color: red; font-weight: bold; margin-top: 10px;">
                            Zum L√∂schen es Accounts <u>Delete</u> eingeben:
                        </p>
                        <input type="text" name="confirm_delete" placeholder="Delete" value="" required>

                        <button type="submit" style="background-color: darkred; color: white; margin-top: 10px;">
                            Account l√∂schen
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="link-content">
            <a href="{{ url_for('index') }}" class="back-button1 sound-button">Zur√ºck zum Login</a>
        </div>
    </div>
</div>

<script>
// Avatar Karussell Funktionalit√§t - WIE IN PLAYERMENU
document.addEventListener("DOMContentLoaded", () => {
    // Avatar Karussell Elemente
    const carouselTrack = document.getElementById("settings-carousel-track");
    const prevButton = document.getElementById("settings-prev-avatar");
    const nextButton = document.getElementById("settings-next-avatar");
    const currentIndexSpan = document.getElementById("settings-current-index");
    const totalAvatarsSpan = document.getElementById("settings-total-avatars");
    const saveAvatarBtn = document.getElementById("save-avatar-btn");
    const usernameInput = document.getElementById("avatar-username");
    const passwordInput = document.getElementById("avatar-password");

    let selectedAvatar = null;
    let currentAvatarIndex = 0;
    let avatars = [];
    const totalAvatarCount = 26;

    // CSRF-Token aus Template
    const csrfToken = "{{ csrf_token() }}";

    // Alle verf√ºgbaren Avatare
    function loadAllAvatars() {
        return Array.from({length: totalAvatarCount}, (_, i) => `avatar${i}.png`);
    }

    // Berechne die drei anzuzeigenden Avatare (links, mitte, rechts)
    function getVisibleAvatars() {
        const prevIndex = (currentAvatarIndex - 1 + totalAvatarCount) % totalAvatarCount;
        const nextIndex = (currentAvatarIndex + 1) % totalAvatarCount;
        return [
            { index: prevIndex, filename: avatars[prevIndex], position: 'left' },
            { index: currentAvatarIndex, filename: avatars[currentAvatarIndex], position: 'center' },
            { index: nextIndex, filename: avatars[nextIndex], position: 'right' }
        ];
    }

    // Avatare im Karussell anzeigen (immer 3 gleichzeitig)
    function displayAvatars() {
        if (!carouselTrack) return;
        
        carouselTrack.innerHTML = '';
        const visibleAvatars = getVisibleAvatars();
        
        visibleAvatars.forEach((avatarData) => {
            const avatarContainer = document.createElement("div");
            avatarContainer.className = `avatar-carousel-item ${avatarData.position}`;
            
            const img = document.createElement("img");
            img.src = "{{ url_for('static', filename='pictures/avatar/') }}" + avatarData.filename;
            img.dataset.filename = avatarData.filename;
            img.dataset.index = avatarData.index;
            img.classList.add("avatar-item");
            
            // Markiere nur den ausgew√§hlten Avatar
            if (avatarData.filename === selectedAvatar) {
                img.classList.add("selected");
            }
            
            img.addEventListener("click", () => {
                // Entferne Auswahl von allen Avataren
                document.querySelectorAll("#settings-carousel-track .avatar-item").forEach(i => i.classList.remove("selected"));
                
                // Setze den angeklickten Avatar als ausgew√§hlt
                img.classList.add("selected");
                selectedAvatar = avatarData.filename;
                
                // WENN AUF SEITLICHEN AVATAR GEKLICKT WIRD: ZENTRIEREN
                if (avatarData.position !== 'center') {
                    currentAvatarIndex = avatarData.index;
                    displayAvatars();
                }
            });
            
            avatarContainer.appendChild(img);
            carouselTrack.appendChild(avatarContainer);
        });
        
        updateCarousel();
    }

    // Karussell initialisieren
    function initializeAvatarCarousel() {
        avatars = loadAllAvatars();
        selectedAvatar = avatars[0]; // Ersten Avatar vorausw√§hlen
        currentAvatarIndex = 0;
        displayAvatars();
    }

    // Karussell-Position aktualisieren
    function updateCarousel() {
        if (currentIndexSpan) currentIndexSpan.textContent = currentAvatarIndex + 1;
        if (totalAvatarsSpan) totalAvatarsSpan.textContent = totalAvatarCount;
    }

    // Vorherigen Avatar anzeigen (zirkul√§r)
    prevButton.addEventListener("click", () => {
        currentAvatarIndex = (currentAvatarIndex - 1 + totalAvatarCount) % totalAvatarCount;
        selectedAvatar = avatars[currentAvatarIndex]; // Avatar automatisch ausw√§hlen
        displayAvatars();
    });

    // N√§chsten Avatar anzeigen (zirkul√§r)
    nextButton.addEventListener("click", () => {
        currentAvatarIndex = (currentAvatarIndex + 1) % totalAvatarCount;
        selectedAvatar = avatars[currentAvatarIndex]; // Avatar automatisch ausw√§hlen
        displayAvatars();
    });

    // Avatar speichern
    saveAvatarBtn.addEventListener("click", () => {
        // Validierung der Eingabefelder
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
            createFlashMessage("Bitte f√ºlle Benutzername und Passwort aus!", "error");
            return;
        }

        if (!selectedAvatar) {
            createFlashMessage("Bitte w√§hle einen Avatar aus!", "error");
            return;
        }

        const formData = new FormData();
        formData.append('avatar', selectedAvatar);
        formData.append('username', username);
        formData.append('password', password);
        formData.append('csrf_token', csrfToken);

        fetch("{{ url_for('change_avatar') }}", {
            method: "POST",
            body: formData
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                if (data.unchanged) {
                    createFlashMessage("Der Avatar wurde nicht ge√§ndert!", "info");
                } else {
                    createFlashMessage("Avatar erfolgreich ge√§ndert!", "success");
                    // Felder zur√ºcksetzen
                    usernameInput.value = '';
                    passwordInput.value = '';
                }
            } else {
                createFlashMessage(data.error || "Fehler beim √Ñndern des Avatars!", "error");
            }
        })
        .catch(err => {
            console.error("Fetch error:", err);
            createFlashMessage("Fehler beim Verbinden mit dem Server!", "error");
        });
    });

    // Karussell beim Laden initialisieren
    initializeAvatarCarousel();

    // --- Passwort Toggle f√ºr alle Passwort-Felder (wie im Index) ---
    const pwToggles = document.querySelectorAll('.pw-toggle');

    pwToggles.forEach(toggle => {
        // verhindert, dass der Button-Klick den Fokus/den Caret verschiebt
        toggle.addEventListener('mousedown', function(e) { e.preventDefault(); });

        toggle.addEventListener('click', function(e) {
            const pwField = this.parentElement.querySelector('input');
            if (!pwField) return;

            const isHidden = pwField.type === 'password';
            // Toggle type
            pwField.type = isHidden ? 'text' : 'password';
            this.setAttribute('aria-pressed', String(isHidden));

            // Icon sauber wechseln
            const icon = this.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-eye', 'fa-eye-slash');
                icon.classList.add(isHidden ? 'fa-eye-slash' : 'fa-eye');
            }

            // Fokussieren und Caret immer ans Ende setzen (setTimeout f√ºr Browser-Quirks)
            pwField.focus();
            setTimeout(() => {
                try {
                    const pos = pwField.value.length;
                    pwField.setSelectionRange(pos, pos);
                } catch (err) {
                    // setSelectionRange kann in einigen seltenen F√§llen fehlschlagen ‚Äî dann ignorieren
                }
            }, 0);
        });
    });

    // --- Toggle-Logik: Nur eine Box darf ge√∂ffnet sein ---
    const toggles = document.querySelectorAll('.setting-toggle');

    toggles.forEach(toggle => {
        toggle.addEventListener('click', function () {
            const thisContent = this.nextElementSibling;
            const thisIcon = this.querySelector('i');
            const isOpen = thisContent.style.maxHeight; // aktuell offen?

            // üîπ Zuerst ALLE schlie√üen (auch Icons zur√ºckdrehen)
            toggles.forEach(other => {
                const content = other.nextElementSibling;
                const icon = other.querySelector('i');
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            });

            // üîπ Dann ggf. das angeklickte Element √∂ffnen
            if (!isOpen) {
                thisContent.style.maxHeight = thisContent.scrollHeight + "px";
                thisIcon.style.transform = 'rotate(180deg)';

                // Wenn Avatar-Sektion ge√∂ffnet wird, Karussell neu initialisieren
                if (this.textContent.includes('Avatar')) {
                    setTimeout(() => {
                        initializeAvatarCarousel();
                    }, 100);
                }
            }
        });
    });
});
</script>
{% endblock %}