{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_playermenu.css') }}"/>
{% endblock %}

{% block body %}
<body class="playermenu-page">
    <div class="playermenu-wrapper">

        <!-- Profilkarte -->
        <div class="player-card">

            <!-- √úberschrift -->
            <h1 class="playermenu-title">Spielermen√º</h1>

            <!-- Avatar + Username Kasten -->
            <div class="player-info-box">

                <!-- Linke Box: Avatar + Button -->
                <div class="avatar-button-box">
                    <div class="avatar-container">
                        <img src="{{ url_for('static', filename='pictures/avatar/' + avatar) }}" alt="Avatar" class="player-avatar">
                        <button id="open-avatar-modal" class="small-circle-button">‚úèÔ∏è</button>
                    </div>
                </div>

                <!-- Rechte Box: Username + Infos -->
                <div class="username-box">
                    <h2 class="player-username">{{ username }}</h2>
                    <p class="player-info">
                        Registriert am: {{ first_played.strftime('%d.%m.%Y %H:%M') if first_played else "Unbekannt" }}
                    </p>
                    <p class="player-info">Highscore: {{ highscore }}</p>
                </div>

            </div>

            <!-- Buttons unten -->
            <div class="menu-buttons">
                <a href="{{ url_for('homepage') }}" class="circle-button singleplayer sound-button">
                    <span>üéÆ</span>
                    <p>Singleplayer</p>
                </a>
                <a href="{{ url_for('playermenu') }}" class="circle-button multiplayer sound-button">
                    <span>‚öîÔ∏è</span>
                    <p>Multiplayer</p>
                    <p>Coming Soon</p>
                </a>
            </div>

        </div>

    </div>

    <!-- Avatar-Auswahl Modal -->
    <div id="avatar-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Avatar √§ndern</h2>
            <div id="avatar-list" class="avatar-list">
                <!-- Avatare werden hier dynamisch geladen -->
            </div>
            <div class="modal-buttons">
                <button id="save-avatar" class="modal-action-button">Speichern</button>
                <button id="cancel-avatar" class="modal-cancel-button">Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("avatar-modal");
        const openBtn = document.getElementById("open-avatar-modal");
        const closeBtn = modal.querySelector(".close-button");
        const cancelBtn = document.getElementById("cancel-avatar");
        const saveBtn = document.getElementById("save-avatar");
        const avatarList = document.getElementById("avatar-list");

        let selectedAvatar = null;

        // Avatare dynamisch laden
        const avatars = ['avatar0.png','avatar1.png','avatar2.png','avatar3.png','avatar4.png'];
        avatars.forEach(av => {
            const img = document.createElement("img");
            img.src = "{{ url_for('static', filename='pictures/avatar/') }}" + av;
            img.dataset.filename = av;
            img.classList.add("avatar-item");
            img.addEventListener("click", () => {
                document.querySelectorAll(".avatar-list img").forEach(i => i.classList.remove("selected"));
                img.classList.add("selected");
                selectedAvatar = av;
            });
            avatarList.appendChild(img);
        });

        // Modal √∂ffnen
        openBtn.addEventListener("click", () => modal.style.display = "flex");

        // Modal schlie√üen
        closeBtn.addEventListener("click", () => modal.style.display = "none");
        cancelBtn.addEventListener("click", () => modal.style.display = "none");

        // Avatar speichern
        saveBtn.addEventListener("click", () => {
            if (!selectedAvatar) return alert("Bitte w√§hle einen Avatar aus!");
            fetch("{{ url_for('change_avatar') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() }}"
                },
                body: JSON.stringify({avatar: selectedAvatar})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(".player-avatar").src = "{{ url_for('static', filename='pictures/avatar/') }}" + selectedAvatar;
                    modal.style.display = "none";
                    alert("Avatar erfolgreich ge√§ndert!");
                } else {
                    alert(data.error || "Fehler beim √Ñndern des Avatars!");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Fehler beim Verbinden mit dem Server!");
            });
        });

        // Klick au√üerhalb des Modal schlie√üt es
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
    });
    </script>
</body>
{% endblock %}
