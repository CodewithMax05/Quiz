{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_playermenu.css') }}"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block body %}
<body class="playermenu-page">
    <div class="playermenu-wrapper">
        <!-- Profilkarte -->
        <div class="player-card">
            <!-- √úberschrift + Zur√ºck-Button -->
            <div class="title-bar">
                <h1 class="playermenu-title">Spielermen√º</h1>
                <a href="{{ url_for('logout') }}" class="back-circle-button sound-button">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>

            <!-- Avatar + Username Kasten -->
            <div class="player-info-box">
                <!-- Linke Box: Avatar + Button -->
                <div class="avatar-button-box">
                    <div class="avatar-container">
                        <img src="{{ url_for('static', filename='pictures/avatar/' + avatar) }}" alt="Avatar" class="player-avatar">
                        <button id="open-avatar-modal" class="small-circle-button">‚úèÔ∏è</button>
                    </div>
                </div>

                <!-- Rechte Box: Username + Infos -->
                <div class="username-box">
                    <h2 class="player-username">{{ username }}</h2>
                    <p class="player-info">
                        Registriert am: {{ first_played.strftime('%d.%m.%Y %H:%M') if first_played else "Unbekannt" }}
                    </p>
                    <p class="player-info">Highscore: {{ highscore }}</p>
                </div>
            </div>

            <!-- Buttons unten -->
            <div class="menu-buttons">
                <a href="{{ url_for('homepage') }}" class="circle-button singleplayer sound-button">
                    <span>üéÆ</span>
                    <p>Singleplayer</p>
                </a>
                <a href="{{ url_for('playermenu') }}" class="circle-button multiplayer sound-button">
                    <span>‚öîÔ∏è</span>
                    <p>Multiplayer</p>
                    <p>Coming Soon</p>
                </a>
            </div>
        </div>
    </div>

    <!-- Avatar-Auswahl Modal -->
    <div id="avatar-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Avatar √§ndern</h2>
            
            <!-- Karussell Container -->
            <div class="carousel-container">
                <button class="carousel-button prev-button" id="prev-avatar">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="avatar-carousel">
                    <div class="carousel-track" id="carousel-track">
                        <!-- Avatare werden hier dynamisch geladen -->
                    </div>
                </div>
                
                <button class="carousel-button next-button" id="next-avatar">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="carousel-indicator">
                <span id="current-index">1</span> / <span id="total-avatars">26</span>
            </div>
            
            <div class="modal-buttons">
                <button id="save-avatar" class="modal-action-button">Speichern</button>
                <button id="cancel-avatar" class="modal-cancel-button">Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("avatar-modal");
        const openBtn = document.getElementById("open-avatar-modal");
        const closeBtn = modal.querySelector(".close-button");
        const cancelBtn = document.getElementById("cancel-avatar");
        const saveBtn = document.getElementById("save-avatar");
        const carouselTrack = document.getElementById("carousel-track");
        const prevButton = document.getElementById("prev-avatar");
        const nextButton = document.getElementById("next-avatar");
        const currentIndexSpan = document.getElementById("current-index");
        const totalAvatarsSpan = document.getElementById("total-avatars");

        let selectedAvatar = null;
        let currentAvatarIndex = 0;
        let avatars = [];
        const totalAvatarCount = 26;

        // CSRF-Token aus Template
        const csrfToken = "{{ csrf_token() }}";

        // Alle verf√ºgbaren Avatare
        function loadAllAvatars() {
            return Array.from({length: totalAvatarCount}, (_, i) => `avatar${i}.png`);
        }

        // Berechne die drei anzuzeigenden Avatare (links, mitte, rechts)
        function getVisibleAvatars() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Auf Mobilger√§ten: nur den aktuellen Avatar anzeigen
                return [
                    { index: currentAvatarIndex, filename: avatars[currentAvatarIndex], position: 'center' }
                ];
            } else {
                // Auf Desktop: drei Avatare anzeigen
                const prevIndex = (currentAvatarIndex - 1 + totalAvatarCount) % totalAvatarCount;
                const nextIndex = (currentAvatarIndex + 1) % totalAvatarCount;
                return [
                    { index: prevIndex, filename: avatars[prevIndex], position: 'left' },
                    { index: currentAvatarIndex, filename: avatars[currentAvatarIndex], position: 'center' },
                    { index: nextIndex, filename: avatars[nextIndex], position: 'right' }
                ];
            }
        }


        // Avatare im Karussell anzeigen (immer 3 gleichzeitig)
        function displayAvatars() {
            carouselTrack.innerHTML = '';
            const visibleAvatars = getVisibleAvatars();
            
            visibleAvatars.forEach((avatarData) => {
                const avatarContainer = document.createElement("div");
                avatarContainer.className = `avatar-carousel-item ${avatarData.position}`;
                
                const img = document.createElement("img");
                img.src = "{{ url_for('static', filename='pictures/avatar/') }}" + avatarData.filename;
                img.dataset.filename = avatarData.filename;
                img.dataset.index = avatarData.index;
                img.classList.add("avatar-item");
                
                // Markiere nur den ausgew√§hlten Avatar
                if (avatarData.filename === selectedAvatar) {
                    img.classList.add("selected");
                }
                
                img.addEventListener("click", () => {
                        // Entferne Auswahl von allen Avataren
                        document.querySelectorAll(".avatar-item").forEach(i => i.classList.remove("selected"));
                        
                        // Setze den angeklickten Avatar als ausgew√§hlt
                        img.classList.add("selected");
                        selectedAvatar = avatarData.filename;
                        
                        // Auf Desktop: Wenn auf einen seitlichen Avatar geklickt wird, navigiere dorthin
                        const isMobile = window.innerWidth <= 768;
                        if (!isMobile && avatarData.position !== 'center') {
                            currentAvatarIndex = avatarData.index;
                            displayAvatars();
                        }
                    });
                    
                    avatarContainer.appendChild(img);
                    carouselTrack.appendChild(avatarContainer);
                });
            
            updateCarousel();
        }

        // Den korrekten anf√§nglichen Avatar setzen
        function initializeAvatarSelection() {
            avatars = loadAllAvatars();
            
            // Avatar aus dem aktuell angezeigten Bild auslesen
            const currentPlayerAvatar = document.querySelector(".player-avatar");
            const currentAvatar = currentPlayerAvatar.src.split('/').pop();
            
            const currentIndex = avatars.findIndex(av => av === currentAvatar);
            if (currentIndex !== -1) {
                currentAvatarIndex = currentIndex;
                selectedAvatar = currentAvatar;
            } else {
                // Fallback: avatar0 als Standard
                currentAvatarIndex = 0;
                selectedAvatar = avatars[0];
            }
            
            displayAvatars();
        }

        // Karussell-Position aktualisieren
        function updateCarousel() {
            currentIndexSpan.textContent = currentAvatarIndex + 1;
            totalAvatarsSpan.textContent = totalAvatarCount;
        }

        // Vorherigen Avatar anzeigen (zirkul√§r)
        prevButton.addEventListener("click", () => {
            currentAvatarIndex = (currentAvatarIndex - 1 + totalAvatarCount) % totalAvatarCount;
            displayAvatars();
        });

        // N√§chsten Avatar anzeigen (zirkul√§r)
        nextButton.addEventListener("click", () => {
            currentAvatarIndex = (currentAvatarIndex + 1) % totalAvatarCount;
            displayAvatars();
        });

        // Modal √∂ffnen
        openBtn.addEventListener("click", () => {
            initializeAvatarSelection();
            modal.style.display = "flex";
        });

        // Modal schlie√üen
        closeBtn.addEventListener("click", () => modal.style.display = "none");
        cancelBtn.addEventListener("click", () => modal.style.display = "none");

        // Avatar speichern
        saveBtn.addEventListener("click", () => {
            if (!selectedAvatar) {
                createFlashMessage("Bitte w√§hle einen Avatar aus!", "error");
                return;
            }

            const formData = new FormData();
            formData.append('avatar', selectedAvatar);
            formData.append('csrf_token', "{{ csrf_token() }}");

            fetch("{{ url_for('update_avatar') }}", {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    // Avatar-Bild aktualisieren
                    const playerAvatar = document.querySelector(".player-avatar");
                    playerAvatar.src = "{{ url_for('static', filename='pictures/avatar/') }}" + selectedAvatar;
                    
                    modal.style.display = "none";
                    createFlashMessage("Avatar erfolgreich ge√§ndert!", "success");
                } else {
                    createFlashMessage(data.error || "Fehler beim √Ñndern des Avatars!", "error");
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                createFlashMessage("Fehler beim Verbinden mit dem Server!", "error");
            });
        });

        // Klick au√üerhalb des Modal schlie√üt es
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });

        // Resize-Listener f√ºr bessere mobile Erfahrung
        window.addEventListener("resize", displayAvatars);
    });
    </script>
</body>
{% endblock %}