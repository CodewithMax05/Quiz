{% extends "base.html" %}

{% block head %}
    <title>Support Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_tickets.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">

    <div class="container">
        <h1 class="support-title">Support Tickets</h1>
    </div>

    <div class="tickets-content">
        {% if tickets %}
        <table class="tickets-table {{ 'with-player' if is_admin else '' }}">
            <thead>
                <tr>
                    <th class="ticket-date">Datum</th>
                    {% if is_admin %}
                    <th class="ticket-player">Spieler</th>
                    {% endif %}
                    <th class="ticket-subject">Betreff</th>
                    <th class="ticket-category">Kategorie</th>
                    <th class="ticket-status">Status</th>
                    <th class="ticket-update">Updates</th>
                </tr>
            </thead>
            <tbody id="tickets-tbody">
                {% for ticket in tickets %}
                
                {# --- LOGIK FÃœR UNGELESENE NACHRICHTEN --- #}
                {% set unread_count = 0 %}
                {% if is_admin %}
                    {# Admin prÃ¼ft auf ungelesene Nachrichten vom USER #}
                    {% set unread_count = ticket.messages.filter_by(sender_type='user', read=False).count() %}
                {% else %}
                    {# User prÃ¼ft auf ungelesene Nachrichten vom ADMIN #}
                    {% set unread_count = ticket.messages.filter_by(sender_type='admin', read=False).count() %}
                {% endif %}

                <tr class="ticket-row" data-ticket-id="{{ ticket.id }}">
                    <td>
                        <time class="utc-time" data-iso="{{ ticket.created_at|to_iso }}">
                            {{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </time>
                    </td>
                    {% if is_admin %}
                    <td>{{ ticket.user.username }}</td>
                    {% endif %}
                    <td>{{ ticket.subject }}</td>
                    <td>{{ ticket.category }}</td>
                    <td>
                        {% if ticket.status == 'open' %}
                            <span class="status-badge status-open">OFFEN</span>
                        {% else %}
                            <span class="status-badge status-closed">GESCHLOSSEN</span>
                        {% endif %}
                    </td>
                    
                    <td class="ticket-update-cell">
                        {% if unread_count > 0 %}
                            <div class="update-indicator new">
                                <i class="fas fa-envelope"></i>
                                <span class="update-text">Neu</span>
                                <span class="update-dot"></span>
                            </div>
                        {% else %}
                            <div class="update-indicator seen">
                                <i class="fas fa-check"></i>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
            <i class="fas fa-spinner fa-spin"></i> Lade weitere Tickets...
        </div>
        
        <div id="end-of-tickets" style="display: none; text-align: center; padding: 20px; color: #666;">
            Alle Tickets geladen
        </div>
        
        {% else %}
        <p class="no-tickets">ðŸ“­ Es sind keine Tickets vorhanden.</p>
        {% endif %}
    </div>

    <div class="buttons-container">
        <div class="button-group">
            {% if is_admin %}
                <a href="{{ url_for('admin_panel') }}" class="back-button sound-button">
                    <i class="fas fa-chevron-left"></i> <span class="btn-text">Admin-Panel</span>
                </a>
            {% else %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('playermenu') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> <span class="btn-text">MenÃ¼</span>
                    </a>
                {% else %}
                    <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> <span class="btn-text">MenÃ¼</span>
                    </a>
                {% endif %}
            {% endif %}
        </div>
        
        <div class="filter-container">
            <select id="filter-sort" class="filter-select sound-button">
                <option value="date_desc" selected>ðŸ“… Neueste zuerst</option>
                <option value="date_asc">ðŸ“… Ã„lteste zuerst</option>
                <option value="subject_asc">ðŸ”¤ Betreff (A-Z)</option>
                <option value="subject_desc">ðŸ”¤ Betreff (Z-A)</option>
            </select>

            <select id="filter-status" class="filter-select sound-button">
                <option value="all" selected>S: Alle</option>
                <option value="open">ðŸ”“ Offen</option>
                <option value="closed">ðŸ”’ Geschlossen</option>
            </select>

            <select id="filter-category" class="filter-select sound-button">
                <option value="all" selected>K: Alle</option>
                <option value="Feedback">Feedback</option>
                <option value="Account">Account</option>
                <option value="Fehlermeldung">Fehlermeldung</option>
                <option value="Missbrauch">Missbrauch</option>
                <option value="Quiz Frage">Quiz Frage</option>
                <option value="Sonstiges">Sonstiges</option>
            </select>

            {% if is_admin %}
            <div class="search-wrapper">
                <input type="text" id="filter-player" class="filter-input" placeholder="Spieler suchen...">
                <i class="fas fa-search search-icon"></i>
            </div>
            {% endif %}
        </div>
        
        <div class="button-group">
            {% if not is_admin %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('ticket_create', return_to='playermenu') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> <span class="btn-text">Ticket</span>
                    </a>
                {% else %}
                    <a href="{{ url_for('ticket_create', return_to='homepage') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> <span class="btn-text">Ticket</span>
                    </a>
                {% endif %}
            {% else %}
                <button class="create-button disabled" disabled>
                    <i class="fas fa-plus"></i> <span class="btn-text">Ticket</span>
                </button>
            {% endif %}
        </div>
    </div>

</div>

<script>
    // URL fÃ¼r die API
    const apiTicketsUrl = "{{ url_for('api_tickets') }}";
    
    // Globale Filter-Variablen
    let filterDebounceTimer;

    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Event Delegation fÃ¼r Klicks auf Tickets (bestehender Code) ---
        const tbody = document.getElementById('tickets-tbody');
        if (tbody) {
            tbody.addEventListener('click', function(e) {
                const row = e.target.closest('.ticket-row');
                if (row && row.dataset.ticketId) {
                    if (e.target.tagName.toLowerCase() === 'a' || e.target.closest('a')) return;
                    window.location.href = '/ticket/' + row.dataset.ticketId;
                }
            });
        }
        
        // --- 2. Filter Event Listeners (NEU) ---
        const filterElements = ['filter-sort', 'filter-status', 'filter-category'];
        filterElements.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('change', resetAndReloadTickets);
            }
        });

        // Spezieller Listener fÃ¼r das Textfeld (mit Debounce, damit nicht bei jedem Tastendruck geladen wird)
        const playerInput = document.getElementById('filter-player');
        if (playerInput) {
            playerInput.addEventListener('input', function() {
                clearTimeout(filterDebounceTimer);
                filterDebounceTimer = setTimeout(resetAndReloadTickets, 500); // Warte 500ms nach Tippen
            });
        }

        // Infinite Scrolling aktivieren
        setupTicketsInfiniteScroll();
    });
    
    // Infinite Scrolling Variablen
    let currentTicketPage = 1;
    let isLoadingTickets = false;
    let hasMoreTicketPages = true;

    // --- NEU: Funktion zum ZurÃ¼cksetzen und Neuladen bei FilterÃ¤nderung ---
    function resetAndReloadTickets() {
        // 1. Reset Variablen
        currentTicketPage = 0; // Wir setzen auf 0, loadMoreTickets macht +1 daraus
        hasMoreTicketPages = true;
        
        // 2. Tabelle leeren
        const tbody = document.getElementById('tickets-tbody');
        if (tbody) tbody.innerHTML = '';
        
        // 3. UI Status zurÃ¼cksetzen
        const noTicketsMsg = document.querySelector('.no-tickets');
        if (noTicketsMsg) noTicketsMsg.remove(); // Falls "Keine Tickets" angezeigt wurde, weg damit
        
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) endIndicator.style.display = 'none';

        // 4. Neu laden
        loadMoreTickets();
    }
    
    // Bestehende Scroll Funktion (unverÃ¤ndert)
    function setupTicketsInfiniteScroll() {
        const ticketsContent = document.querySelector('.tickets-content');
        if (!ticketsContent) return;
        
        ticketsContent.addEventListener('scroll', function() {
            if (isLoadingTickets || !hasMoreTicketPages) return;
            
            const scrollTop = ticketsContent.scrollTop;
            const scrollHeight = ticketsContent.scrollHeight;
            const clientHeight = ticketsContent.clientHeight;
            
            if (scrollTop + clientHeight >= scrollHeight * 0.9) {
                loadMoreTickets();
            }
        });
        
        // Initial Check (Falls Filter sofort Ergebnisse leer lÃ¤sst oder Screen groÃŸ ist)
        setTimeout(() => {
             // Nur laden, wenn die Tabelle leer ist (z.B. durch Filter-Reset) oder scrollbar
            if (ticketsContent.scrollHeight <= ticketsContent.clientHeight && hasMoreTicketPages) {
                loadMoreTickets();
            }
        }, 500);
    }
    
    // --- MODIFIZIERT: API Aufruf mit Filter-Parametern ---
    async function loadMoreTickets() {
        if (isLoadingTickets || !hasMoreTicketPages) return;
        
        isLoadingTickets = true;
        
        const loadingIndicator = document.getElementById('loading-indicator');
        const endIndicator = document.getElementById('end-of-tickets');
        const tbody = document.getElementById('tickets-tbody');

        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (endIndicator) endIndicator.style.display = 'none';
        
        try {
            const nextPage = currentTicketPage + 1;
            
            // --- NEU: Parameter sammeln ---
            const sort = document.getElementById('filter-sort')?.value || 'date_desc';
            const status = document.getElementById('filter-status')?.value || 'all';
            const category = document.getElementById('filter-category')?.value || 'all';
            const player = document.getElementById('filter-player')?.value || '';

            // URL mit Parametern bauen
            const params = new URLSearchParams({
                page: nextPage,
                sort: sort,
                status: status,
                category: category,
                player: player
            });

            const response = await fetch(`${apiTicketsUrl}?${params.toString()}`);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            if (data.tickets && data.tickets.length > 0) {
                appendTicketsToTable(data.tickets);
                currentTicketPage = nextPage;
                hasMoreTicketPages = data.has_next;
                
                if (!hasMoreTicketPages) showEndOfTicketsIndicator();
            } else {
                hasMoreTicketPages = false;
                showEndOfTicketsIndicator();
                
                // Wenn es Seite 1 war und keine Tickets kamen: Leere Nachricht anzeigen
                if (nextPage === 1 && tbody.children.length === 0) {
                    const ticketsContent = document.querySelector('.tickets-content');
                    if(!document.querySelector('.no-tickets')) {
                        const p = document.createElement('p');
                        p.className = 'no-tickets';
                        p.innerHTML = 'ðŸ” Keine Tickets gefunden fÃ¼r diese Filter.';
                        ticketsContent.appendChild(p);
                    }
                }
            }
        } catch (error) {
            console.error('Fehler:', error);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        } finally {
            isLoadingTickets = false;
        }
    }
    
    // appendTicketsToTable bleibt identisch wie in deiner Datei...
    function appendTicketsToTable(tickets) {
        const tbody = document.getElementById('tickets-tbody');
        if (!tbody) return;
        
        const hasPlayerColumn = document.querySelector('.tickets-table th.ticket-player') !== null;
        
        tickets.forEach((ticket) => {
            const row = document.createElement('tr');
            row.className = 'ticket-row';
            row.setAttribute('data-ticket-id', ticket.id);
            
            // 1. Datum
            const dateCell = document.createElement('td');
            const timeElement = document.createElement('time');
            timeElement.className = 'utc-time';
            timeElement.setAttribute('data-iso', ticket.created_at);
            timeElement.textContent = '...';
            dateCell.appendChild(timeElement);
            row.appendChild(dateCell);
            
            // 2. Spieler (optional)
            if (hasPlayerColumn) {
                const playerCell = document.createElement('td');
                playerCell.textContent = ticket.user || 'Unbekannt';
                row.appendChild(playerCell);
            }
            
            // 3. Betreff
            const subjectCell = document.createElement('td');
            subjectCell.textContent = ticket.subject;
            row.appendChild(subjectCell);
            
            // 4. Kategorie
            const categoryCell = document.createElement('td');
            categoryCell.textContent = ticket.category;
            row.appendChild(categoryCell);
            
            // 5. Status
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            if (ticket.status === 'open') {
                statusBadge.className = 'status-badge status-open';
                statusBadge.textContent = 'OFFEN';
            } else {
                statusBadge.className = 'status-badge status-closed';
                statusBadge.textContent = 'GESCHLOSSEN';
            }
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            // 6. Update
            const updateCell = document.createElement('td');
            updateCell.className = 'ticket-update-cell';
            const indicator = document.createElement('div');
            
            if (ticket.unread_count && ticket.unread_count > 0) {
                indicator.className = 'update-indicator new';
                indicator.innerHTML = '<i class="fas fa-envelope"></i><span class="update-text">Neu</span>';
            } else {
                indicator.className = 'update-indicator seen';
                indicator.innerHTML = '<i class="fas fa-check"></i>';
            }
            updateCell.appendChild(indicator);
            row.appendChild(updateCell);
            
            tbody.appendChild(row);
        });
        
        if (typeof convertUtcTimeElements === 'function') {
            convertUtcTimeElements(tbody);
        }
    }
    
    function showEndOfTicketsIndicator() {
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) endIndicator.style.display = 'block';
    }
</script>
{% endblock %}