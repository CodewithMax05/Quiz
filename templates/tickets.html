{% extends "base.html" %}

{% block head %}
    <title>Support Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_tickets.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">

    <div class="container">
        <h1 class="support-title">Support Tickets</h1>
    </div>

    <div class="tickets-content">
        {% if tickets %}
        <table class="tickets-table {{ 'with-player' if is_admin else '' }}">
            <thead>
                <tr>
                    <th class="ticket-date">Datum</th>
                    {% if is_admin %}
                    <th class="ticket-player">Spieler</th>
                    {% endif %}
                    <th class="ticket-subject">Betreff</th>
                    <th class="ticket-category">Kategorie</th>
                    <th class="ticket-status">Status</th>
                    <th class="ticket-update">Updates</th>
                </tr>
            </thead>
            <tbody id="tickets-tbody">
                {% for ticket in tickets %}
                
                {# --- LOGIK F√úR UNGELESENE NACHRICHTEN --- #}
                {% set unread_count = 0 %}
                {% if is_admin %}
                    {# Admin pr√ºft auf ungelesene Nachrichten vom USER #}
                    {% set unread_count = ticket.messages.filter_by(sender_type='user', read=False).count() %}
                {% else %}
                    {# User pr√ºft auf ungelesene Nachrichten vom ADMIN #}
                    {% set unread_count = ticket.messages.filter_by(sender_type='admin', read=False).count() %}
                {% endif %}

                <tr class="ticket-row" data-ticket-id="{{ ticket.id }}">
                    <td>
                        <time class="utc-time" data-iso="{{ ticket.created_at|to_iso }}">
                            {{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </time>
                    </td>
                    {% if is_admin %}
                    <td>{{ ticket.user.username }}</td>
                    {% endif %}
                    <td>{{ ticket.subject }}</td>
                    <td>{{ ticket.category }}</td>
                    <td>
                        {% if ticket.status == 'open' %}
                            <span class="status-badge status-open">OFFEN</span>
                        {% else %}
                            <span class="status-badge status-closed">GESCHLOSSEN</span>
                        {% endif %}
                    </td>
                    
                    <td class="ticket-update-cell">
                        {% if unread_count > 0 %}
                            <div class="update-indicator new">
                                <i class="fas fa-envelope"></i>
                                <span class="update-text">Neu</span>
                                <span class="update-dot"></span>
                            </div>
                        {% else %}
                            <div class="update-indicator seen">
                                <i class="fas fa-check"></i>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
            <i class="fas fa-spinner fa-spin"></i> Lade weitere Tickets...
        </div>
        
        <div id="end-of-tickets" style="display: none; text-align: center; padding: 20px; color: #666;">
            Alle Tickets geladen
        </div>
        
        {% else %}
        <p class="no-tickets">üì≠ Es sind keine Tickets vorhanden.</p>
        {% endif %}
    </div>

    <div class="buttons-container">
        <div class="button-group">
            {% if is_admin %}
                <a href="{{ url_for('admin_panel') }}" class="back-button sound-button">
                    <i class="fas fa-chevron-left"></i> Zur√ºck zum Admin-Panel
                </a>
            {% else %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('playermenu') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> Zur√ºck zum Spielermen√º
                    </a>
                {% else %}
                    <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> Zur√ºck zum Themenmen√º
                    </a>
                {% endif %}
            {% endif %}
        </div>
        
        <div class="button-group">
            {% if not is_admin %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('ticket_create', return_to='playermenu') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> Neues Ticket erstellen
                    </a>
                {% else %}
                    <a href="{{ url_for('ticket_create', return_to='homepage') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> Neues Ticket erstellen
                    </a>
                {% endif %}
            {% else %}
                <button class="create-button disabled" disabled>
                    <i class="fas fa-plus"></i> Neues Ticket erstellen
                </button>
            {% endif %}
        </div>
    </div>

</div>

<script>
    // URL f√ºr die API dynamisch aus Flask generieren
    const apiTicketsUrl = "{{ url_for('api_tickets') }}";

    document.addEventListener('DOMContentLoaded', function() {
        // --- OPTIMIERUNG: Event Delegation ---
        // Statt Listener auf jede Zeile, ein Listener auf den Container (tbody)
        const tbody = document.getElementById('tickets-tbody');
        if (tbody) {
            tbody.addEventListener('click', function(e) {
                // Pr√ºfen, ob eine Zeile (oder ein Kind davon) geklickt wurde
                const row = e.target.closest('.ticket-row');
                
                // Wenn eine Zeile gefunden wurde UND sie eine ID hat
                if (row && row.dataset.ticketId) {
                    // Verhindern, dass der Klick feuert, wenn man explizit auf den "Ansehen" Link klickt
                    // (Sonst w√ºrde das Event doppelt verarbeitet oder k√∂nnte zu Problemen f√ºhren)
                    if (e.target.tagName.toLowerCase() === 'a' || e.target.closest('a')) return;
                    
                    // Weiterleitung
                    window.location.href = '/ticket/' + row.dataset.ticketId;
                }
            });
        }
        
        // Infinite Scrolling aktivieren
        setupTicketsInfiniteScroll();
    });
    
    // Infinite Scrolling Variablen
    let currentTicketPage = 1;
    let isLoadingTickets = false;
    let hasMoreTicketPages = true;
    
    function setupTicketsInfiniteScroll() {
        const ticketsContent = document.querySelector('.tickets-content');
        if (!ticketsContent) return;
        
        ticketsContent.addEventListener('scroll', function() {
            if (isLoadingTickets || !hasMoreTicketPages) return;
            
            const scrollTop = ticketsContent.scrollTop;
            const scrollHeight = ticketsContent.scrollHeight;
            const clientHeight = ticketsContent.clientHeight;
            
            // Wenn 90% des Inhalts gescrollt wurde, lade mehr Tickets
            if (scrollTop + clientHeight >= scrollHeight * 0.9) {
                loadMoreTickets();
            }
        });
        
        // Initial pr√ºfen, ob Content so klein ist, dass kein Scrollbalken da ist (dann sofort nachladen)
        setTimeout(() => {
            if (ticketsContent.scrollHeight <= ticketsContent.clientHeight && hasMoreTicketPages) {
                loadMoreTickets();
            }
        }, 500);
    }
    
    async function loadMoreTickets() {
        if (isLoadingTickets || !hasMoreTicketPages) return;
        
        isLoadingTickets = true;
        
        // Loading Indicator anzeigen
        const loadingIndicator = document.getElementById('loading-indicator');
        const endIndicator = document.getElementById('end-of-tickets');
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (endIndicator) endIndicator.style.display = 'none';
        
        try {
            const nextPage = currentTicketPage + 1;
            // Verwendung der oben definierten Konstante
            const response = await fetch(`${apiTicketsUrl}?page=${nextPage}`);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            // Loading Indicator ausblenden
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            if (data.tickets && data.tickets.length > 0) {
                appendTicketsToTable(data.tickets);
                currentTicketPage = nextPage;
                hasMoreTicketPages = data.has_next;
                
                // Wenn keine weiteren Seiten, zeige End-of-List Indicator
                if (!hasMoreTicketPages) {
                    showEndOfTicketsIndicator();
                }
            } else {
                hasMoreTicketPages = false;
                showEndOfTicketsIndicator();
            }
        } catch (error) {
            console.error('Fehler beim Laden weiterer Tickets:', error);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            // Fallback falls createFlashMessage nicht global verf√ºgbar ist
            if (typeof createFlashMessage === 'function') {
                createFlashMessage('Fehler beim Laden weiterer Tickets', 'error');
            }
        } finally {
            isLoadingTickets = false;
        }
    }
    
    function appendTicketsToTable(tickets) {
        const tbody = document.getElementById('tickets-tbody');
        if (!tbody) return;
        
        // Wir pr√ºfen das DOM, ob die Admin-Spalte (Spieler) existiert
        const hasPlayerColumn = document.querySelector('.tickets-table th.ticket-player') !== null;
        
        tickets.forEach((ticket) => {
            const row = document.createElement('tr');
            row.className = 'ticket-row';
            row.setAttribute('data-ticket-id', ticket.id);
            
            // 1. Datum Zelle
            const dateCell = document.createElement('td');
            const timeElement = document.createElement('time');
            timeElement.className = 'utc-time';
            // Falls das API ISO-Format sendet
            timeElement.setAttribute('data-iso', ticket.created_at);
            timeElement.textContent = 'L√§dt...';
            dateCell.appendChild(timeElement);
            row.appendChild(dateCell);
            
            // 2. Spieler Zelle (nur wenn im Header vorhanden)
            if (hasPlayerColumn) {
                const playerCell = document.createElement('td');
                playerCell.textContent = ticket.user || 'Unbekannt';
                row.appendChild(playerCell);
            }
            
            // 3. Betreff Zelle
            const subjectCell = document.createElement('td');
            subjectCell.textContent = ticket.subject;
            row.appendChild(subjectCell);
            
            // 4. Kategorie Zelle
            const categoryCell = document.createElement('td');
            categoryCell.textContent = ticket.category;
            row.appendChild(categoryCell);
            
            // 5. Status Zelle
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            if (ticket.status === 'open') {
                statusBadge.className = 'status-badge status-open';
                statusBadge.textContent = 'OFFEN';
            } else {
                statusBadge.className = 'status-badge status-closed';
                statusBadge.textContent = 'GESCHLOSSEN';
            }
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            // 6. Update Zelle
            const updateCell = document.createElement('td');
            updateCell.className = 'ticket-update-cell';

            if (ticket.unread_count && ticket.unread_count > 0) {
                const indicator = document.createElement('div');
                indicator.className = 'update-indicator new';
                indicator.innerHTML = '<i class="fas fa-envelope"></i><span class="update-text">Neu</span>';
                updateCell.appendChild(indicator);
            } else {
                const indicator = document.createElement('div');
                indicator.className = 'update-indicator seen';
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                updateCell.appendChild(indicator);
            }
            
            row.appendChild(updateCell);
            
            tbody.appendChild(row);
        });
        
        // Zeit-Konvertierung f√ºr die neu eingef√ºgten Elemente ansto√üen
        if (typeof convertUtcTimeElements === 'function') {
            convertUtcTimeElements(tbody);
        }
    }
    
    function showEndOfTicketsIndicator() {
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) {
            endIndicator.style.display = 'block';
        }
    }
</script>
{% endblock %}