{% extends "base.html" %}

{% block head %}
    <title>Support Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_tickets.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">

    <div class="container">
        <h1 class="support-title">Support Tickets</h1>

        <div class="buttons-container">
            <div class="button-group">
                {% if is_admin %}
                    <a href="{{ url_for('admin_panel') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> <span class="btn-text">Admin-Panel</span>
                    </a>
                {% else %}
                    {% if return_to == 'playermenu' %}
                        <a href="{{ url_for('playermenu') }}" class="back-button sound-button">
                            <i class="fas fa-chevron-left"></i> <span class="btn-text">MenÃ¼</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                            <i class="fas fa-chevron-left"></i> <span class="btn-text">MenÃ¼</span>
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="filter-container">
                <select id="filter-sort" class="filter-select sound-button">
                    <option value="date_desc" selected>ðŸ“… Neueste</option>
                    <option value="date_asc">ðŸ“… Ã„lteste</option>
                    <option value="subject_asc">ðŸ”¤ Betreff (A-Z)</option>
                    <option value="subject_desc">ðŸ”¤ Betreff (Z-A)</option>
                </select>
    
                <select id="filter-status" class="filter-select sound-button">
                    <option value="all" selected>Alle</option>
                    <option value="open">ðŸ”“ Offen</option>
                    <option value="closed">ðŸ”’ Geschlossen</option>
                </select>
    
                <select id="filter-category" class="filter-select sound-button">
                    <option value="all" selected>Alle</option>
                    <option value="Feedback">Feedback</option>
                    <option value="Account">Account</option>
                    <option value="Fehlermeldung">Fehler</option>
                    <option value="Missbrauch">Missbrauch</option>
                    <option value="Sonstiges">Sonstiges</option>
                </select>
                
                </div>
            
            <div class="button-group">
                {% if is_admin %}
                    <div class="search-wrapper">
                        <input type="text" id="filter-player" class="filter-input" placeholder="Spieler...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                {% else %}
                    {% if return_to == 'playermenu' %}
                        <a href="{{ url_for('ticket_create', return_to='playermenu') }}" class="create-button sound-button">
                            <i class="fas fa-plus"></i> <span class="btn-text">Ticket</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('ticket_create', return_to='homepage') }}" class="create-button sound-button">
                            <i class="fas fa-plus"></i> <span class="btn-text">Ticket</span>
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="tickets-scroll-wrapper">
            {% if tickets %}
            <table class="tickets-table {{ 'with-player' if is_admin else '' }}">
                <thead>
                    <tr>
                        <th class="ticket-date">Datum</th>
                        {% if is_admin %}
                        <th class="ticket-player">Spieler</th>
                        {% endif %}
                        <th class="ticket-subject">Betreff</th>
                        <th class="ticket-category">Kategorie</th>
                        <th class="ticket-status">Status</th>
                        <th class="ticket-update">Updates</th>
                    </tr>
                </thead>
                <tbody id="tickets-tbody">
                    {% for ticket in tickets %}
                    
                    {% set unread_count = 0 %}
                    {% if is_admin %}
                        {% set unread_count = ticket.messages.filter_by(sender_type='user', read=False).count() %}
                    {% else %}
                        {% set unread_count = ticket.messages.filter_by(sender_type='admin', read=False).count() %}
                    {% endif %}

                    <tr class="ticket-row" data-ticket-id="{{ ticket.id }}">
                        <td data-label="Datum">
                            <time class="utc-time" data-iso="{{ ticket.created_at|to_iso }}">
                                {{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </time>
                        </td>
                        {% if is_admin %}
                        <td data-label="Spieler" class="ticket-player-cell" title="{{ ticket.user.username }}">{{ ticket.user.username }}</td>
                        {% endif %}
                        
                        <td data-label="Betreff" class="ticket-subject-cell" title="{{ ticket.subject }}">{{ ticket.subject }}</td>
                        
                        <td data-label="Kategorie">{{ ticket.category }}</td>
                        <td data-label="Status">
                            {% if ticket.status == 'open' %}
                                <span class="status-badge status-open">OFFEN</span>
                            {% else %}
                                <span class="status-badge status-closed">GESCHLOSSEN</span>
                            {% endif %}
                        </td>
                        
                        <td class="ticket-update-cell" data-label="Update">
                            {% if unread_count > 0 %}
                                <div class="update-indicator new">
                                    <i class="fas fa-envelope"></i>
                                    <span class="update-text">Neu</span>
                                </div>
                            {% else %}
                                <div class="update-indicator seen">
                                    <i class="fas fa-eye"></i>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div id="loading-indicator" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Lade weitere Tickets...
            </div>
            
            <div id="end-of-tickets" style="display: none;">
                Alle Tickets geladen
            </div>
            
            {% else %}
            <p class="no-tickets">ðŸ“­ Aktuell sind keine Tickets vorhanden.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    const apiTicketsUrl = "{{ url_for('api_tickets') }}";
    let filterDebounceTimer;

    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('tickets-tbody');
        if (tbody) {
            tbody.addEventListener('click', function(e) {
                const row = e.target.closest('.ticket-row');
                if (row && row.dataset.ticketId) {
                    if (e.target.tagName.toLowerCase() === 'a' || e.target.closest('a')) return;
                    window.location.href = '/ticket/' + row.dataset.ticketId;
                }
            });
        }
        
        const filterElements = ['filter-sort', 'filter-status', 'filter-category'];
        filterElements.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('change', resetAndReloadTickets);
        });

        const playerInput = document.getElementById('filter-player');
        if (playerInput) {
            playerInput.addEventListener('input', function() {
                clearTimeout(filterDebounceTimer);
                filterDebounceTimer = setTimeout(resetAndReloadTickets, 500);
            });
        }

        setupTicketsInfiniteScroll();
    });
    
    let currentTicketPage = 1;
    let isLoadingTickets = false;
    let hasMoreTicketPages = true;

    function resetAndReloadTickets() {
        currentTicketPage = 0;
        hasMoreTicketPages = true;
        
        const tbody = document.getElementById('tickets-tbody');
        if (tbody) tbody.innerHTML = '';
        
        const noTicketsMsg = document.querySelector('.no-tickets');
        if (noTicketsMsg) noTicketsMsg.remove();
        
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) endIndicator.style.display = 'none';

        loadMoreTickets();
    }
    
    function setupTicketsInfiniteScroll() {
        const ticketsContent = document.querySelector('.tickets-scroll-wrapper');
        if (!ticketsContent) return;
        
        ticketsContent.addEventListener('scroll', function() {
            if (isLoadingTickets || !hasMoreTicketPages) return;
            
            const scrollTop = ticketsContent.scrollTop;
            const scrollHeight = ticketsContent.scrollHeight;
            const clientHeight = ticketsContent.clientHeight;
            
            if (scrollTop + clientHeight >= scrollHeight * 0.9) {
                loadMoreTickets();
            }
        });
        
        setTimeout(() => {
            if (ticketsContent.scrollHeight <= ticketsContent.clientHeight && hasMoreTicketPages) {
                loadMoreTickets();
            }
        }, 500);
    }
    
    async function loadMoreTickets() {
        if (isLoadingTickets || !hasMoreTicketPages) return;
        
        isLoadingTickets = true;
        
        const loadingIndicator = document.getElementById('loading-indicator');
        const endIndicator = document.getElementById('end-of-tickets');
        const tbody = document.getElementById('tickets-tbody');
        const scrollWrapper = document.querySelector('.tickets-scroll-wrapper');

        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (endIndicator) endIndicator.style.display = 'none';
        
        try {
            const nextPage = currentTicketPage + 1;
            
            const sort = document.getElementById('filter-sort')?.value || 'date_desc';
            const status = document.getElementById('filter-status')?.value || 'all';
            const category = document.getElementById('filter-category')?.value || 'all';
            const player = document.getElementById('filter-player')?.value || '';

            const params = new URLSearchParams({
                page: nextPage,
                sort: sort,
                status: status,
                category: category,
                player: player
            });

            const response = await fetch(`${apiTicketsUrl}?${params.toString()}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            if (data.tickets && data.tickets.length > 0) {
                appendTicketsToTable(data.tickets);
                currentTicketPage = nextPage;
                hasMoreTicketPages = data.has_next;
                if (!hasMoreTicketPages) showEndOfTicketsIndicator();
            } else {
                hasMoreTicketPages = false;
                showEndOfTicketsIndicator();
                
                if (nextPage === 1 && (!tbody || tbody.children.length === 0)) {
                    if(!document.querySelector('.no-tickets')) {
                        const p = document.createElement('p');
                        p.className = 'no-tickets';
                        p.innerHTML = 'ðŸ“­ Keine Tickets gefunden.';
                        scrollWrapper.appendChild(p);
                    }
                }
            }
        } catch (error) {
            console.error('Fehler:', error);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        } finally {
            isLoadingTickets = false;
        }
    }
    
    function appendTicketsToTable(tickets) {
        let tbody = document.getElementById('tickets-tbody');
        
        if (!tbody) {
            const scrollWrapper = document.querySelector('.tickets-scroll-wrapper');
            const noTickets = scrollWrapper.querySelector('.no-tickets');
            if(noTickets) noTickets.remove();

            const table = document.querySelector('.tickets-table');
            if(table) {
                tbody = document.createElement('tbody');
                tbody.id = 'tickets-tbody';
                table.appendChild(tbody);
            }
        }
        if (!tbody) return; 
        
        const hasPlayerColumn = document.querySelector('.tickets-table th.ticket-player') !== null;
        
        tickets.forEach((ticket) => {
            const row = document.createElement('tr');
            row.className = 'ticket-row';
            row.setAttribute('data-ticket-id', ticket.id);
            
            const createCell = (text, label, className = '') => {
                const td = document.createElement('td');
                if(className) td.className = className;
                td.setAttribute('data-label', label);
                
                if (className.includes('ticket-subject-cell') || className.includes('ticket-player-cell')) {
                    td.setAttribute('title', text);
                }
                
                td.textContent = text;
                return td;
            };

            const dateCell = document.createElement('td');
            dateCell.setAttribute('data-label', 'Datum');
            const timeElement = document.createElement('time');
            timeElement.className = 'utc-time';
            timeElement.setAttribute('data-iso', ticket.created_at);
            timeElement.textContent = '...';
            dateCell.appendChild(timeElement);
            row.appendChild(dateCell);
            
            if (hasPlayerColumn) {
                row.appendChild(createCell(ticket.user || 'Unbekannt', 'Spieler', 'ticket-player-cell'));
            }
            
            row.appendChild(createCell(ticket.subject, 'Betreff', 'ticket-subject-cell'));
            row.appendChild(createCell(ticket.category, 'Kategorie'));
            
            const statusCell = document.createElement('td');
            statusCell.setAttribute('data-label', 'Status');
            const statusBadge = document.createElement('span');
            if (ticket.status === 'open') {
                statusBadge.className = 'status-badge status-open';
                statusBadge.textContent = 'OFFEN';
            } else {
                statusBadge.className = 'status-badge status-closed';
                statusBadge.textContent = 'GESCHLOSSEN';
            }
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            const updateCell = document.createElement('td');
            updateCell.className = 'ticket-update-cell';
            updateCell.setAttribute('data-label', 'Update');
            const indicator = document.createElement('div');
            
            if (ticket.unread_count && ticket.unread_count > 0) {
                indicator.className = 'update-indicator new';
                indicator.innerHTML = '<i class="fas fa-envelope"></i><span class="update-text">Neu</span>';
            } else {
                indicator.className = 'update-indicator seen';
                indicator.innerHTML = '<i class="fas fa-eye"></i>';
            }
            updateCell.appendChild(indicator);
            row.appendChild(updateCell);
            
            tbody.appendChild(row);
        });
        
        if (typeof convertUtcTimeElements === 'function') {
            convertUtcTimeElements(tbody);
        }
    }
    
    function showEndOfTicketsIndicator() {
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) endIndicator.style.display = 'block';
    }
</script>
{% endblock %}