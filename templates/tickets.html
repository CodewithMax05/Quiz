{% extends "base.html" %}

{% block head %}
    <title>Support Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_tickets.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="page-wrapper">

    <div class="container">
        <h1 class="support-title">Support Tickets</h1>
    </div>

    <div class="tickets-content">
        {% if tickets %}
        <table class="tickets-table">
            <thead>
                <tr>
                    <th class="ticket-date">Datum</th>
                    {% if is_admin %}
                    <th class="ticket-player">Spieler</th>
                    {% endif %}
                    <th class="ticket-subject">Betreff</th>
                    <th class="ticket-category">Kategorie</th>
                    <th class="ticket-status">Status</th>
                    <th class="ticket-action">Aktion</th>
                </tr>
            </thead>
            <tbody id="tickets-tbody">
                {% for ticket in tickets %}
                <tr class="ticket-row" data-ticket-id="{{ ticket.id }}">
                    <td>
                        <time class="utc-time" data-iso="{{ ticket.created_at|to_iso }}">
                            {{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </time>
                    </td>
                    {% if is_admin %}
                    <td>{{ ticket.user.username }}</td>
                    {% endif %}
                    <td>{{ ticket.subject }}</td>
                    <td>{{ ticket.category }}</td>
                    <td>
                        {% if ticket.status == 'open' %}
                            <span class="status-badge status-open">OFFEN</span>
                        {% else %}
                            <span class="status-badge status-closed">GESCHLOSSEN</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="action-link">Ansehen</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
            <i class="fas fa-spinner fa-spin"></i> Lade weitere Tickets...
        </div>
        
        <!-- End of List Indicator -->
        <div id="end-of-tickets" style="display: none; text-align: center; padding: 20px; color: #666;">
            Alle Tickets geladen
        </div>
        
        {% else %}
        <p class="no-tickets">üì≠ Es sind keine Tickets vorhanden.</p>
        {% endif %}
    </div>

    <div class="buttons-container">
        <div class="button-group">
            {% if is_admin %}
                <a href="{{ url_for('admin_panel') }}" class="back-button sound-button">
                    <i class="fas fa-chevron-left"></i> Zur√ºck zur Admin-Panel
                </a>
            {% else %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('playermenu') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> Zur√ºck zum Spielermen√º
                    </a>
                {% else %}
                    <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                        <i class="fas fa-chevron-left"></i> Zur√ºck zum Themenmen√º
                    </a>
                {% endif %}
            {% endif %}
        </div>
        
        <div class="button-group">
            {% if not is_admin %}
                {% if return_to == 'playermenu' %}
                    <a href="{{ url_for('ticket_create', return_to='playermenu') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> Neues Ticket erstellen
                    </a>
                {% else %}
                    <a href="{{ url_for('ticket_create', return_to='homepage') }}" class="create-button sound-button">
                        <i class="fas fa-plus"></i> Neues Ticket erstellen
                    </a>
                {% endif %}
            {% else %}
                <button class="create-button disabled" disabled>
                    <i class="fas fa-plus"></i> Neues Ticket erstellen
                </button>
            {% endif %}
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Klick auf Ticket-Zeilen
        document.querySelectorAll('.ticket-row').forEach(function(row) {
            row.addEventListener('click', function() {
                const ticketId = this.getAttribute('data-ticket-id');
                window.location.href = '/ticket/' + ticketId;
            });
        });
        
        // Infinite Scrolling f√ºr Tickets
        setupTicketsInfiniteScroll();
    });
    
    // Infinite Scrolling Variablen
    let currentTicketPage = 1;
    let isLoadingTickets = false;
    let hasMoreTicketPages = true;
    
    function setupTicketsInfiniteScroll() {
        const ticketsContent = document.querySelector('.tickets-content');
        if (!ticketsContent) return;
        
        ticketsContent.addEventListener('scroll', function() {
            if (isLoadingTickets || !hasMoreTicketPages) return;
            
            const scrollTop = ticketsContent.scrollTop;
            const scrollHeight = ticketsContent.scrollHeight;
            const clientHeight = ticketsContent.clientHeight;
            
            // Wenn 90% des Inhalts gescrollt wurde, lade mehr Tickets
            if (scrollTop + clientHeight >= scrollHeight * 0.9) {
                loadMoreTickets();
            }
        });
        
        // Initial pr√ºfen, ob mehr Tickets geladen werden m√ºssen
        setTimeout(() => {
            if (ticketsContent.scrollHeight <= ticketsContent.clientHeight && hasMoreTicketPages) {
                loadMoreTickets();
            }
        }, 500);
    }
    
    async function loadMoreTickets() {
        if (isLoadingTickets || !hasMoreTicketPages) return;
        
        isLoadingTickets = true;
        
        // Loading Indicator anzeigen
        const loadingIndicator = document.getElementById('loading-indicator');
        const endIndicator = document.getElementById('end-of-tickets');
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (endIndicator) endIndicator.style.display = 'none';
        
        try {
            const nextPage = currentTicketPage + 1;
            const response = await fetch(`/api/tickets?page=${nextPage}`);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            // Loading Indicator ausblenden
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            if (data.tickets && data.tickets.length > 0) {
                appendTicketsToTable(data.tickets);
                currentTicketPage = nextPage;
                hasMoreTicketPages = data.has_next;
                
                // Wenn keine weiteren Seiten, zeige End-of-List Indicator
                if (!hasMoreTicketPages) {
                    showEndOfTicketsIndicator();
                }
            } else {
                hasMoreTicketPages = false;
                showEndOfTicketsIndicator();
            }
        } catch (error) {
            console.error('Fehler beim Laden weiterer Tickets:', error);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            createFlashMessage('Fehler beim Laden weiterer Tickets', 'error');
        } finally {
            isLoadingTickets = false;
        }
    }
    
    function appendTicketsToTable(tickets) {
        const tbody = document.getElementById('tickets-tbody');
        if (!tbody) return;
        
        const isAdmin = document.body.dataset.isAdmin === 'true' || 
                       document.querySelector('.page-wrapper').dataset.isAdmin === 'true';
        
        tickets.forEach((ticket) => {
            const row = document.createElement('tr');
            row.className = 'ticket-row';
            row.setAttribute('data-ticket-id', ticket.id);
            row.onclick = () => window.location.href = '/ticket/' + ticket.id;
            
            // Datum Zelle
            const dateCell = document.createElement('td');
            const timeElement = document.createElement('time');
            timeElement.className = 'utc-time';
            timeElement.setAttribute('data-iso', ticket.created_at);
            timeElement.textContent = 'L√§dt...';
            dateCell.appendChild(timeElement);
            
            row.appendChild(dateCell);
            
            // Spieler Zelle (nur f√ºr Admin)
            if (isAdmin) {
                const playerCell = document.createElement('td');
                playerCell.textContent = ticket.user || 'Unbekannt';
                row.appendChild(playerCell);
            }
            
            // Betreff Zelle
            const subjectCell = document.createElement('td');
            subjectCell.textContent = ticket.subject;
            row.appendChild(subjectCell);
            
            // Kategorie Zelle
            const categoryCell = document.createElement('td');
            categoryCell.textContent = ticket.category;
            row.appendChild(categoryCell);
            
            // Status Zelle
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = ticket.status === 'open' ? 
                'status-badge status-open' : 'status-badge status-closed';
            statusBadge.textContent = ticket.status === 'open' ? 'OFFEN' : 'GESCHLOSSEN';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            // Aktion Zelle
            const actionCell = document.createElement('td');
            const actionLink = document.createElement('a');
            actionLink.href = `/ticket/${ticket.id}`;
            actionLink.className = 'action-link';
            actionLink.textContent = 'Ansehen';
            actionCell.appendChild(actionLink);
            row.appendChild(actionCell);
            
            tbody.appendChild(row);
        });
        
        // Zeit-Konvertierung f√ºr neue Elemente
        if (typeof convertUtcTimeElements === 'function') {
            convertUtcTimeElements(tbody);
        }
    }
    
    function showEndOfTicketsIndicator() {
        const endIndicator = document.getElementById('end-of-tickets');
        if (endIndicator) {
            endIndicator.style.display = 'block';
        }
    }
</script>
{% endblock %}