{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_ranking.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <!-- Haupt-Container -->
    <body class="ranking-page">
        <div class="ranking-wrapper">
            <!-- Zentrierte Ãœberschrift -->
            <h1 class="ranking-title">Top 10 Spieler</h1>

            <!-- Inhalt unter der Ãœberschrift -->
            <div class="ranking-content">
                <!-- Linke Spalte (Leaderboard) -->
                <div class="ranking-column-left">
                    <div class="leaderboard">
                        <div class="leaderboard-header">
                            <div class="header-item">Platz</div>
                            <div class="header-item">Username</div>
                            <div class="header-item">Punkte</div>
                            <div class="header-item">Highscrore-Datum</div>
                        </div>
                        
                        <!-- Top 10 Liste -->
                        <div class="leaderboard-content">
                            {% for player in top_players %}
                            <div class="leaderboard-row {% if loop.index <= 3 %}podium{% endif %}" 
                                data-rank="{{ player_rank_map[player.id] }}"     
                                data-user-id="{{ player.id }}"
                                data-username="{{ player.username }}"
                                data-registered="{{ player.first_played|to_local_time }}"
                                data-score="{{ player.highscore }}"
                                data-highscore-date="{% if player.highscore_time %}{{ player.highscore_time|to_local_time }}{% endif %}"
                                data-correct="{{ player.correct_high }}"
                                onclick="updatePlayerInfo(this)">
                                <div class="leaderboard-cell position">
                                    {% if loop.index == 1 %}ðŸ¥‡
                                    {% elif loop.index == 2 %}ðŸ¥ˆ
                                    {% elif loop.index == 3 %}ðŸ¥‰
                                    {% else %}{{ loop.index }}{% endif %}
                                </div>
                                <div class="leaderboard-cell username">{{ player.username }}</div>
                                <div class="leaderboard-cell score">{{ player.highscore }}</div>
                                <div class="leaderboard-cell date">
                                    {% if player.highscore_time %}
                                        {{ player.highscore_time | to_local_time }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Eigene Platzierung -->
                        {% if current_player %}
                        <div class="leaderboard-header platzierung-header" style="margin-top: 2rem;">
                            <div class="header-item">Deine Platzierung</div>
                            <div class="header-item"></div>
                            <div class="header-item"></div>
                            <div class="header-item"></div>
                        </div>
                        <div class="leaderboard-row highlight" 
                            data-rank="{{ player_rank }}"
                            data-user-id="{{ current_player.id }}"
                            data-username="{{ current_player.username }}"
                            data-registered="{{ current_player.first_played|to_local_time }}"
                            data-score="{{ current_player.highscore }}"
                            data-highscore-date="{% if current_player.highscore_time %}{{ current_player.highscore_time|to_local_time }}{% endif %}"
                            data-correct="{{ current_player.correct_high }}"
                            onclick="updatePlayerInfo(this)">
                            <div class="leaderboard-cell position">
                                {% if player_rank %}#{{ player_rank }}
                                {% else %}N/A{% endif %}
                            </div>
                            <div class="leaderboard-cell username">{{ current_player.username }}</div>
                            <div class="leaderboard-cell score">{{ current_player.highscore }}</div>
                            <div class="leaderboard-cell date">
                                {% if current_player and current_player.highscore_time %}
                                    {{ current_player.highscore_time | to_local_time }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Rechte Spalte (Unter der Liste) -->
                <div class="ranking-column-right">
                    <!-- Einfache Suchleiste -->
                    <div class="search-wrapper">
                        <input type="text" id="player-search" placeholder="Spieler suchen..." 
                            onkeypress="if(event.key === 'Enter') searchPlayer()">
                        <button type="button" class="search-button sound-button" aria-label="Spieler suchen" onclick="searchPlayer()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <!-- Spielerinfo-Karte -->
                    <div class="player-info-card">
                        <div class="player-info-title-row">
                            <a href="#" class="ranking-info-button" id="ranking-info-button" aria-label="Information">
                                <i class="fas fa-question-circle"></i>
                            </a>
                            <h3>Spielerprofil</h3>
                        </div>
                        <div class="player-info-content">
                            <div class="info-row">
                                <span class="info-label">Platzierung:</span>
                                <span id="info-rank" class="info-value">
                                    {% if player_rank %}{{ player_rank }}{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Username:</span>
                                <span id="info-username" class="info-value">{{ current_player.username if current_player else "N/A" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Spieler-ID:</span>
                                <span id="info-id" class="info-value">{{ current_player.id if current_player else "N/A" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Registriert am:</span>
                                <span id="info-registered" class="info-value">
                                    {% if current_player %}{{ current_player.first_played|to_local_time }}{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="info-row highlight">
                                <span class="info-label">Highscore:</span>
                                <span id="info-highscore" class="info-value">{{ current_player.highscore if current_player else "0" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Highscoredatum:</span>
                                <span id="info-highscore-date" class="info-value">
                                    {% if current_player and current_player.highscore_time %}
                                        {{ current_player.highscore_time|to_local_time }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Richtige Fragen:</span>
                                <span id="info-correct" class="info-value">{{ current_player.correct_high if current_player else "0" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZurÃ¼ck-Button -->
                    <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                        <i class="fas fa-arrow-left"></i> ZurÃ¼ck zur Themenwahl
                    </a>
                </div>
            </div>
        </div>
    </body>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Session-Flag setzen dass wir auf der Ranking-Seite sind
            fetch('/api/set_ranking_flag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).catch(e => console.log('Flag setzen fehlgeschlagen:', e));
            
            const defaultPlayer = document.querySelector('.leaderboard-row.highlight');
            if (defaultPlayer) {
                defaultPlayer.classList.add('active');
            }

            // Info-Button Funktion
            const infoButton = document.getElementById('ranking-info-button');
            const flashContainer = document.getElementById('flash-container');
            
            infoButton.addEventListener('click', function(e) {
                e.preventDefault();
                createFlashMessage('Weitere Informationen zum Spieler durch Klick oder Suche', 'info');
            });

            function createFlashMessage(text, type = 'info') {
                // LÃ¶sche alle vorhandenen Nachrichten
                flashContainer.innerHTML = '';
                
                // Neue Nachricht erstellen
                const messageDiv = document.createElement('div');
                messageDiv.className = `${type === 'error' ? 'error-message' : 'info-message'}`;
                messageDiv.textContent = text;
                
                // Fortschrittsbalken hinzufÃ¼gen
                const progressBar = document.createElement('div');
                progressBar.className = 'custom-progress-bar';
                messageDiv.appendChild(progressBar);
                
                // Nachricht in den Container einfÃ¼gen
                flashContainer.appendChild(messageDiv);
                
                // Nachricht nach 5 Sekunden entfernen
                setTimeout(() => {
                    messageDiv.style.animation = 'fadeOut 0.5s forwards';
                    setTimeout(() => {
                        if (flashContainer.contains(messageDiv)) {
                            flashContainer.removeChild(messageDiv);
                        }
                    }, 500);
                }, 5000);
            }

            window.createFlashMessage = createFlashMessage;
        });

        function updatePlayerInfo(row) {
            // Highlight aktive Zeile
            document.querySelectorAll('.leaderboard-row').forEach(r => r.classList.remove('active'));
            row.classList.add('active');

            // Alle Daten aktualisieren
            const rank = row.dataset.rank;
            document.getElementById('info-rank').textContent = (!rank || rank === "None") ? "N/A" : rank;
            document.getElementById('info-username').textContent = row.dataset.username || "N/A";
            document.getElementById('info-id').textContent = row.dataset.userId || "N/A";
            document.getElementById('info-registered').textContent = row.dataset.registered || "N/A";
            document.getElementById('info-highscore').textContent = row.dataset.score || "0";
            document.getElementById('info-highscore-date').textContent = row.dataset.highscoreDate || "N/A";
            document.getElementById('info-correct').textContent = row.dataset.correct || "0";
        }

        async function searchPlayer() {
            const searchInput = document.getElementById('player-search');
            const username = searchInput.value.trim();
            
            if (!username) {
                createFlashMessage('Bitte gib einen Benutzernamen ein', 'error');
                return;
            }

            try {
                const response = await fetch('/api/search_player', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username
                    })
                });
                
                if (!response.ok) {
                    // Fehler vom Server als JSON parsen
                    const errorData = await response.json();
                    createFlashMessage(errorData.error || 'Ein Fehler ist aufgetreten', 'error');
                    return;
                }

                const data = await response.json();

                // Spielerdaten anzeigen
                document.getElementById('info-rank').textContent = data.rank ? `${data.rank}` : "N/A";
                document.getElementById('info-username').textContent = data.username || "N/A";
                document.getElementById('info-id').textContent = data.id || "N/A";
                document.getElementById('info-registered').textContent = data.first_played || "N/A";
                document.getElementById('info-highscore').textContent = data.highscore || "0";
                document.getElementById('info-highscore-date').textContent = data.highscore_time || "N/A";
                document.getElementById('info-correct').textContent = data.correct_high || "0";
                
                // Highlight entfernen
                document.querySelectorAll('.leaderboard-row').forEach(r => r.classList.remove('active', 'highlight'));
                
            } catch (error) {
                console.error('Fehler bei der Suche:', error);
                createFlashMessage('JJJJJEin Fehler ist aufgetreten', 'error');
            }
        }
    </script>
{% endblock %}