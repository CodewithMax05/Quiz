{% extends "base.html" %} <!-- Erbt von Basis-Template -->

<!--
Ranking-Seite enthÃ¤lt:
    1. Leaderboard mit Top-Spielern und Infinite Scrolling
    2. Eigene Platzierung
    3. Spielersuche per Eingabefeld und Button
    4. Spielerinfo-Karte mit Statistiken
-->

{% block head %}
    <!-- Seiten-spezifisches Stylesheet fÃ¼r Ranking -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_ranking.css') }}"/>
    <!-- Font Awesome fÃ¼r Icons (Such-Button, Info-Button, ZurÃ¼ck-Button) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <body class="ranking-page">
        <!-- Haupt-Container fÃ¼r die gesamte Ranking-Seite -->
        <div class="ranking-wrapper">
            <h1 class="ranking-title">Rangliste der Legenden</h1>

            <!-- Hauptinhalt -->
            <div class="ranking-content">
                <!-- Linke Spalte (Leaderboard/Toppliste) -->
                <div class="ranking-column-left">
                    <!-- Leaderboard-Container -->
                    <div class="leaderboard">
                        <!-- Header fÃ¼r die Top-Liste -->
                        <div class="leaderboard-header top-list-header">
                            <div class="header-item">Platz</div>
                            <div class="header-item">Username</div>
                            <div class="header-item">Punkte</div>
                            <div class="header-item">Highscrore-Datum</div>
                        </div>
                        
                        <!-- Scrollcontainer fÃ¼r Infinite Scrolling der Top-Liste -->
                        <div id="leaderboard-scroll" class="leaderboard-scroll">
                            <!-- Dynamischer Inhalt der Top-Liste -->
                            <div class="leaderboard-content" id="leaderboard-content">
                                <!-- Schleife durch alle Top-Spieler aus dem Backend -->
                                {% for player in top_players %}
                                {% set rank = loop.index %}
                                <!-- Jede Zeile mit Datenattributen fÃ¼r JavaScript-Zugriff -->
                                <div class="leaderboard-row {% if loop.index <= 3 %}podium{% endif %}" 
                                    data-rank="{{ rank }}"     
                                    data-username="{{ player.username }}"
                                    data-avatar="{{ player.avatar }}"
                                    data-registered="{{ player.first_played|to_iso }}"
                                    data-score="{{ player.highscore }}"
                                    data-highscore-date="{% if player.highscore_time %}{{ player.highscore_time|to_iso }}{% endif %}"
                                    data-correct="{{ player.correct_high }}"
                                    data-games="{{ player.number_of_games }}"
                                    onclick="updatePlayerInfo(this)">
                                    <!-- Platzierung mit Emojis fÃ¼r Top 3 -->
                                    <div class="leaderboard-cell position">
                                        {% if rank == 1 %}ðŸ¥‡
                                        {% elif rank == 2 %}ðŸ¥ˆ
                                        {% elif rank == 3 %}ðŸ¥‰
                                        {% else %}{{ rank }}{% endif %}
                                    </div>
                                    <!-- Benutzername mit Tooltip -->
                                    <div class="leaderboard-cell username" title="{{ player.username }}">{{ player.username }}</div>
                                    <!-- Highscore-Punkte -->
                                    <div class="leaderboard-cell score">{{ player.highscore }}</div>
                                    <!-- Highscore-Datum -->
                                    <div class="leaderboard-cell date">
                                        {% if player.highscore_time %}
                                            <time class="utc-time" data-iso="{{ player.highscore_time | to_iso }}">LÃ¤dt...</time>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Eigene Platzierung -->
                        {% if current_player %}
                        <!-- Header fÃ¼r "Deine Platzierung" -->
                        <div class="leaderboard-header platzierung-header" style="margin-top: 1rem;">
                            <div class="header-item">Deine Platzierung</div>
                            <div class="header-item"></div>
                            <div class="header-item"></div>
                            <div class="header-item"></div>
                        </div>
                        <!-- Zeile fÃ¼r eigenen Benutzer -->
                        <div class="leaderboard-row highlight" 
                            data-rank="{{ player_rank }}"
                            data-username="{{ current_player.username }}"
                            data-avatar="{{ current_player.avatar }}"
                            data-registered="{{ current_player.first_played|to_iso }}"
                            data-score="{{ current_player.highscore }}"
                            data-highscore-date="{% if current_player.highscore_time %}{{ current_player.highscore_time|to_iso }}{% endif %}"
                            data-correct="{{ current_player.correct_high }}"
                            data-games="{{ current_player.number_of_games }}"
                            onclick="updatePlayerInfo(this)">
                            <!-- Platzierung -->
                            <div class="leaderboard-cell position">
                                {% if player_rank %}#{{ player_rank }}
                                {% else %}N/A{% endif %}
                            </div>
                            <!-- Benutzername -->
                            <div class="leaderboard-cell username" title="{{ current_player.username }}">{{ current_player.username }}</div>
                            <!-- Highscore -->
                            <div class="leaderboard-cell score">{{ current_player.highscore }}</div>
                            <!-- Highscore-Datum -->
                            <div class="leaderboard-cell date">
                                {% if current_player and current_player.highscore_time %}
                                    <time class="utc-time" data-iso="{{ current_player.highscore_time | to_iso }}">LÃ¤dt...</time>
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Rechte Spalte (Spielersuche und Spielerinfo-Karte) -->
                <div class="ranking-column-right">
                    <!-- Suchleiste fÃ¼r Spieler -->
                    <div class="search-wrapper">
                        <input type="text" id="player-search" placeholder="Spieler suchen..." 
                            onkeypress="if(event.key === 'Enter') searchPlayer()">
                        <button type="button" class="search-button sound-button" aria-label="Spieler suchen" onclick="searchPlayer()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <!-- Spielerinfo-Karte -->
                    <div class="player-info-card">
                        <!-- Titelzeile mit Info-Button -->
                        <div class="player-info-title-row">
                            <a href="#" class="ranking-info-button" id="ranking-info-button" aria-label="Information">
                                <i class="fas fa-question-circle"></i>
                            </a>
                            <h3>Spielerprofil</h3>
                        </div>
                        <!-- Inhalt der Spielerinfo-Karte -->
                        <div class="player-info-content">
                            <!-- Platzierung -->
                            <div class="info-row">
                                <span class="info-label">Platzierung:</span>
                                <span id="info-rank" class="info-value">
                                    {% if player_rank %}{{ player_rank }}{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <!-- Benutzername -->
                            <div class="info-row">
                                <span class="info-label">Username:</span>
                                <span id="info-username" class="info-value">{{ current_player.username if current_player else "N/A" }}</span>
                            </div>
                            <!-- Profilbild -->
                            <div class="info-row avatar-row">
                                <span class="info-label">Profilbild:</span>
                                <div id="info-avatar" class="info-avatar">
                                    {% if current_player %}
                                        <img src="{{ url_for('static', filename='pictures/avatar/' + current_player.avatar) }}" 
                                             alt="Avatar von {{ current_player.username }}"
                                             class="avatar-image">
                                    {% else %}
                                        <div class="avatar-placeholder">N/A</div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Registrierungsdatum -->
                            <div class="info-row">
                                <span class="info-label">Registriert am:</span>
                                <span id="info-registered" class="info-value">
                                    {% if current_player and current_player.first_played %}
                                        <time class="utc-time" data-iso="{{ current_player.first_played|to_iso }}">LÃ¤dt...</time>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                            <!-- Anzahl gespielter Spiele -->
                            <div class="info-row">
                                <span class="info-label">Anzahl Spiele:</span>
                                <span id="info-games" class="info-value">{{ current_player.number_of_games if current_player else "0" }}</span>
                            </div>
                            <!-- Highscore -->
                            <div class="info-row highlight">
                                <span class="info-label">Highscore:</span>
                                <span id="info-highscore" class="info-value">{{ current_player.highscore if current_player else "0" }}</span>
                            </div>
                            <!-- Datum des Highscores -->
                            <div class="info-row">
                                <span class="info-label">Highscoredatum:</span>
                                <span id="info-highscore-date" class="info-value">
                                    {% if current_player and current_player.highscore_time %}
                                        <time class="utc-time" data-iso="{{ current_player.highscore_time|to_iso }}">LÃ¤dt...</time>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                            <!-- Anzahl richtiger Fragen -->
                            <div class="info-row">
                                <span class="info-label">Richtige Fragen:</span>
                                <span id="info-correct" class="info-value">{{ current_player.correct_high if current_player else "0" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZurÃ¼ck-Button zur Themenwahl -->
                    <a href="{{ url_for('homepage') }}" class="back-button sound-button">
                        <i class="fas fa-arrow-left"></i> ZurÃ¼ck zur Themenwahl
                    </a>
                </div>
            </div>
        </div>

        <script>
            /*
            RANKING-SEITEN-LOGIK:
                1. Infinite Scrolling fÃ¼r Leaderboard
                2. Spielersuche via AJAX
                3. Aktualisierung der Spielerinfo-Karte
            */

            // Variablen fÃ¼r Infinite Scrolling
            let currentPage = 1;           // Aktuelle Seite
            let isLoading = false;         // Verhindert parallele LadevorgÃ¤nge
            let hasMorePages = true;       // Gibt an ob weitere Seiten vorhanden sind

            // Initialisierung beim Laden der Seite
            document.addEventListener('DOMContentLoaded', () => {
                // Setze Session-Flag dass wir auf der Ranking-Seite sind
                fetch('/api/set_ranking_flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                }).catch(e => console.log('Flag setzen fehlgeschlagen:', e));
                
                // WÃ¤hle Standard-Spieler (eigenen Benutzer) aus
                const defaultPlayer = document.querySelector('.leaderboard-row.highlight');
                if (defaultPlayer) {
                    defaultPlayer.classList.add('active');
                }

                // Info-Button Funktion
                const infoButton = document.getElementById('ranking-info-button');
                
                infoButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    createFlashMessage('Weitere Informationen zum Spieler durch Klick oder Suche', 'info');
                });

                // Infinite Scrolling einrichten
                setupInfiniteScroll();
            });

            // Infinite Scrolling
            function setupInfiniteScroll() {
                const leaderboardContent = document.getElementById('leaderboard-scroll');
                if (!leaderboardContent) return;
                
                // Event-Listener fÃ¼r Scroll-Ereignis
                leaderboardContent.addEventListener('scroll', function() {
                    if (isLoading || !hasMorePages) return;
                    
                    const scrollTop = leaderboardContent.scrollTop;
                    const scrollHeight = leaderboardContent.scrollHeight;
                    const clientHeight = leaderboardContent.clientHeight;
                    
                    // Wenn 90% des Inhalts gescrollt wurde, lade mehr Spieler
                    if (scrollTop + clientHeight >= scrollHeight * 0.9) {
                        loadMorePlayers();
                    }
                });
            }

            // Weitere Spieler laden (API-Aufruf)
            async function loadMorePlayers() {
                if (isLoading || !hasMorePages) return;
                
                isLoading = true;
                
                const leaderboardContent = document.getElementById('leaderboard-content');
                
                // Entferne bestehende Loading-Indikatoren
                const existingLoader = document.querySelector('.loading-indicator');
                if (existingLoader) {
                    existingLoader.remove();
                }
                
                // Lade-Indikator hinzufÃ¼gen
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.textContent = 'Lade weitere Spieler...';
                leaderboardContent.appendChild(loadingIndicator);
                
                try {
                    const nextPage = currentPage + 1;
                    // API-Aufruf fÃ¼r nÃ¤chste Seite
                    const response = await fetch(`/api/ranking_players?page=${nextPage}`);
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    
                    // Entferne Loading-Indikator
                    const currentLoader = document.querySelector('.loading-indicator');
                    if (currentLoader) {
                        currentLoader.remove();
                    }
                    
                    if (data.players && data.players.length > 0) {
                        // FÃ¼ge Spieler zur Liste hinzu
                        appendPlayersToLeaderboard(data.players);
                        currentPage = nextPage;
                        hasMorePages = data.has_next;
                        
                        // Wenn keine weiteren Seiten, zeige End-of-List Indicator
                        if (!hasMorePages) {
                            showEndOfListIndicator();
                        }
                    } else {
                        hasMorePages = false;
                        showEndOfListIndicator();
                    }
                } catch (error) {
                    console.error('Fehler beim Laden weiterer Spieler:', error);
                    const currentLoader = document.querySelector('.loading-indicator');
                    if (currentLoader) {
                        currentLoader.remove();
                    }
                    createFlashMessage('Fehler beim Laden weiterer Spieler', 'error');
                } finally {
                    isLoading = false;
                }
            }

            // End-of-List Indicator anzeigen (alle Spieler geladen)
            function showEndOfListIndicator() {
                const leaderboardContent = document.getElementById('leaderboard-content');
                const existingEndIndicator = document.querySelector('.end-of-list');
                
                if (!existingEndIndicator) {
                    const endIndicator = document.createElement('div');
                    endIndicator.className = 'end-of-list';
                    endIndicator.textContent = 'Alle Spieler geladen';
                    leaderboardContent.appendChild(endIndicator);
                }
            }

            // Spieler zur Leaderboard-Liste hinzufÃ¼gen
            function appendPlayersToLeaderboard(players) {
                const leaderboardContent = document.getElementById('leaderboard-content');
                if (!leaderboardContent) return;

                players.forEach((player) => {
                    // Erstelle neue Zeile
                    const row = document.createElement('div');
                    row.className = `leaderboard-row ${player.rank <= 3 ? 'podium' : ''}`;
                    row.setAttribute('data-rank', player.rank);
                    row.setAttribute('data-username', player.username);
                    row.setAttribute('data-avatar', player.avatar);
                    row.setAttribute('data-registered', player.first_played);
                    row.setAttribute('data-score', player.highscore);
                    row.setAttribute('data-highscore-date', player.highscore_time);
                    row.setAttribute('data-correct', player.correct_high);
                    row.setAttribute('data-games', player.number_of_games);
                    row.onclick = () => updatePlayerInfo(row);

                    // Platzierungszelle
                    const positionCell = document.createElement('div');
                    positionCell.className = 'leaderboard-cell position';
                    if (player.rank === 1) positionCell.innerHTML = 'ðŸ¥‡';
                    else if (player.rank === 2) positionCell.innerHTML = 'ðŸ¥ˆ';
                    else if (player.rank === 3) positionCell.innerHTML = 'ðŸ¥‰';
                    else positionCell.textContent = player.rank;

                    // Benutzername-Zelle
                    const usernameCell = document.createElement('div');
                    usernameCell.className = 'leaderboard-cell username';
                    usernameCell.setAttribute('title', player.username); // Tooltip bleibt
                    usernameCell.textContent = player.username; // Voller Name

                    // Score-Zelle
                    const scoreCell = document.createElement('div');
                    scoreCell.className = 'leaderboard-cell score';
                    scoreCell.textContent = player.highscore;

                    // Datums-Zelle
                    const dateCell = document.createElement('div');
                    dateCell.className = 'leaderboard-cell date';
                    if (player.highscore_time) {
                        const timeElement = document.createElement('time');
                        timeElement.className = 'utc-time';
                        timeElement.setAttribute('data-iso', player.highscore_time);
                        timeElement.textContent = 'LÃ¤dt...';
                        dateCell.appendChild(timeElement);
                    } else {
                        dateCell.textContent = 'N/A';
                    }

                    // Zellen zur Zeile hinzufÃ¼gen
                    row.appendChild(positionCell);
                    row.appendChild(usernameCell);
                    row.appendChild(scoreCell);
                    row.appendChild(dateCell);

                    // Zeile zum Leaderboard hinzufÃ¼gen
                    leaderboardContent.appendChild(row);
                });

                // Zeit-Konvertierung fÃ¼r neue Elemente (globale Funktion aus base.html)
                convertUtcTimeElements(leaderboardContent);
            }

            // Spielerinformationen aktualisieren (wird bei Klick auf Zeile aufgerufen)
            function updatePlayerInfo(row) {
                // Highlight aktive Zeile
                document.querySelectorAll('.leaderboard-row').forEach(r => r.classList.remove('active'));
                row.classList.add('active');

                // Alle Daten aus den data-Attributen auslesen und anzeigen
                const rank = row.dataset.rank;
                document.getElementById('info-rank').textContent = (!rank || rank === "None") ? "N/A" : rank;
                document.getElementById('info-username').textContent = row.dataset.username || "N/A";
                document.getElementById('info-registered').textContent = formatIsoToLocal(row.dataset.registered) || "N/A";
                document.getElementById('info-games').textContent = row.dataset.games || "0";
                document.getElementById('info-highscore').textContent = row.dataset.score || "0";
                document.getElementById('info-highscore-date').textContent = formatIsoToLocal(row.dataset.highscoreDate) || "N/A";
                document.getElementById('info-correct').textContent = row.dataset.correct || "0";
                
                // Avatar aktualisieren
                const avatarContainer = document.getElementById('info-avatar');
                const avatar = row.dataset.avatar;
                if (avatar && avatar !== "None") {
                    avatarContainer.innerHTML = `<img src="{{ url_for('static', filename='pictures/avatar/') }}${avatar}" 
                                             alt="Avatar von ${row.dataset.username || 'Spieler'}" 
                                             class="avatar-image">`;
                } else {
                    avatarContainer.innerHTML = '<div class="avatar-placeholder">N/A</div>';
                }
            }

            // Spieler suchen (per API)
            async function searchPlayer() {
                const searchInput = document.getElementById('player-search');
                const username = searchInput.value.trim();
                
                if (!username) {
                    createFlashMessage('Bitte gib einen Benutzernamen ein', 'error');
                    return;
                }

                // 1. CSRF-Token holen
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

                try {
                    // API-Aufruf fÃ¼r Spielersuche
                    const response = await fetch('/api/search_player', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken // 2. Token als Header hinzufÃ¼gen
                        },
                        body: JSON.stringify({
                            username: username
                        })
                    });
                    
                    if (!response.ok) {
                        // Fehler vom Server als JSON parsen
                        const errorData = await response.json();
                        createFlashMessage(errorData.error || 'Ein Fehler ist aufgetreten', 'error');
                        return;
                    }

                    const data = await response.json();

                    // Spielerdaten in der Info-Karte anzeigen
                    document.getElementById('info-rank').textContent = data.rank ? `${data.rank}` : "N/A";
                    document.getElementById('info-username').textContent = data.username || "N/A";
                    document.getElementById('info-registered').textContent = formatIsoToLocal(data.first_played) || "N/A";
                    document.getElementById('info-games').textContent = data.number_of_games || "0";
                    document.getElementById('info-highscore').textContent = data.highscore || "0";
                    document.getElementById('info-highscore-date').textContent = formatIsoToLocal(data.highscore_time) || "N/A";
                    document.getElementById('info-correct').textContent = data.correct_high || "0";
                    
                    // Avatar anzeigen
                    const avatarContainer = document.getElementById('info-avatar');
                    if (data.avatar) {
                        avatarContainer.innerHTML = `<img src="{{ url_for('static', filename='pictures/avatar/') }}${data.avatar}" 
                                                     alt="Avatar von ${data.username || 'Spieler'}" 
                                                     class="avatar-image">`;
                    } else {
                        avatarContainer.innerHTML = '<div class="avatar-placeholder">N/A</div>';
                    }
                    
                    // Highlight entfernen (wenn ein Spieler in der Liste angeklickt war)
                    document.querySelectorAll('.leaderboard-row').forEach(r => r.classList.remove('active', 'highlight'));
                    
                } catch (error) {
                    console.error('Fehler bei der Suche:', error);
                    createFlashMessage('Ein Fehler ist aufgetreten', 'error');
                }
            }
        </script>
    </body>
{% endblock %}