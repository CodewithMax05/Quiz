<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="google" content="notranslate">

		 <!-- Favicon Konfiguration -->
		<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
		<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
		<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
		<link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
		<link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
    
		<!-- Browser-Farbthema -->
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="theme-color" content="#1a1a2e">
		
		<!-- CSRF -->
		<meta name="csrf-token" content="{{ csrf_token() }}">

		<!-- Sounds -->
		<audio id="clickSound" preload="auto">
			<source src="{{ url_for('static', filename='sounds/button_klick_1.mp3') }}" type="audio/mpeg">
		</audio>

		{%block head%}

		{% endblock %}
		<!--Titel ändern?-->
		<title>Quiz</title>
	</head>
	<body data-was-correct="{{ 'true' if was_correct else 'false' }}" 
		  data-is-logged-in="{{ 'true' if is_logged_in else 'false' }}"
		  data-automatic-logout-url="{{ url_for('automatic_logout') }}">
		
		{%block body%}

		{% endblock %}

		<!-- Socket.io Script am Ende des body für bessere Ladeleistung -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
		
		<script>
			// Globale Funktion zum Abspielen von Sounds
			function playSound(soundId) {
				try {
					// Sound-Instanz dynamisch erstellen
					const sound = new Audio("{{ url_for('static', filename='sounds/button_klick_1.mp3') }}");
					sound.volume = 1.0;
					sound.play().catch(e => console.log("Sound play failed:", e));
				} catch (e) {
					console.error("Sound error:", e);
				}
			}
			// neu
			// Sound-Event für alle Buttons
			document.addEventListener('DOMContentLoaded', () => {
				document.querySelectorAll('.sound-button').forEach(el => {
					el.addEventListener('click', () => {
						playSound('clickSound');
					});
				});
			});

			/*
			// Event-Listener für alle Buttons
			document.addEventListener('DOMContentLoaded', () => {
				document.querySelectorAll('button, input[type="button"], .sound-button').forEach(button => {
					button.addEventListener('click', () => {
						// Sound nur bei Aktionen ohne Form-Submit
						if (!button.closest('form')) {
							playSound('clickSound');
						}
					});
				});
			}); 
			*/

			// Inaktivitäts-Timer (nur für eingeloggte Benutzer)
			document.addEventListener('DOMContentLoaded', function() {
				// Werte aus den Datenattributen des Body-Elements lesen
				const body = document.body;
				const isLoggedIn = body.getAttribute('data-is-logged-in') === 'true';
				const automaticLogoutUrl = body.getAttribute('data-automatic-logout-url');
				
				if (isLoggedIn) {
					let inactivityTimer;
					let warningTimer;
					const warningTime = 30 * 60 * 1000; // 30 Minuten
					const logoutTime = 35 * 60 * 1000; // 5 (35) Minute nach Warnung (35 Minuten total)
					let warningMessageElement = null;

					function resetInactivityTimer() {
						clearTimeout(inactivityTimer);
						clearTimeout(warningTimer);
						
						// Entferne Warnmeldung, falls vorhanden
						if (warningMessageElement) {
							warningMessageElement.remove();
							warningMessageElement = null;
						}
						
						inactivityTimer = setTimeout(showInactivityWarning, warningTime);
					}

					function showInactivityWarning() {
						// Erstelle Warnmeldung
						warningMessageElement = createFlashMessage('Sie waren 30 Minuten inaktiv. Sie werden in 5 Minute automatisch abgemeldet.', 'warning');
						
						// Setze Timer für automatischen Logout
						warningTimer = setTimeout(logoutDueToInactivity, logoutTime - warningTime);
					}

					function logoutDueToInactivity() {
						// Sofortige Weiterleitung zur Logout-URL
						window.location.href = automaticLogoutUrl;
					}

					function createFlashMessage(text, type) {
						const flashContainer = document.getElementById('flash-container');
						if (!flashContainer) return null;
						
						// Lösche vorhandene Warnungen
						const existingWarnings = flashContainer.querySelectorAll('.warning-message, .info-message');
						existingWarnings.forEach(warning => warning.remove());
						
						const messageDiv = document.createElement('div');
						messageDiv.className = `${type}-message`;
						messageDiv.textContent = text;
						messageDiv.style.zIndex = '9999'; // Sehr hoher z-index
						
						// Fortschrittsbalken für die Warnung (1 Minute)
						const progressBar = document.createElement('div');
						progressBar.className = 'custom-progress-bar';
						progressBar.style.animation = 'progressBar 60s linear forwards'; // 60 Sekunden
						messageDiv.appendChild(progressBar);
						
						// Nachricht nach 1 Minute entfernen
						setTimeout(() => {
							if (flashContainer.contains(messageDiv)) {
								flashContainer.removeChild(messageDiv);
								warningMessageElement = null;
							}
						}, logoutTime - warningTime);
						
						flashContainer.appendChild(messageDiv);
						return messageDiv;
					}

					// Timer starten
					resetInactivityTimer();
					
					// Event-Listener für Aktivität
					const events = ['mousemove', 'keypress', 'touchstart', 'click', 'scroll'];
					events.forEach(event => {
						document.addEventListener(event, resetInactivityTimer);
					});
				}
			});
		</script>
	</body>
</html>