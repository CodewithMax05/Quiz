<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="google" content="notranslate">

		<!-- CSS -->
		<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_base.css') }}">

		<!-- Favicon Konfiguration -->
		<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
		<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
		<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
		<link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
		<link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
    
		<!-- Browser-Farbthema -->
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="theme-color" content="#1a1a2e">
		
		<!-- CSRF -->
		<meta name="csrf-token" content="{{ csrf_token() }}">

		<!-- Sounds -->
		<audio id="clickSound" preload="auto">
			<source src="{{ url_for('static', filename='sounds/button_klick_1.mp3') }}" type="audio/mpeg">
		</audio>

		{%block head%}

		{% endblock %}
		<!--Titel ändern?-->
		<title>Clash of Minds</title>
	</head>
	<body data-was-correct="{{ 'true' if was_correct else 'false' }}" 
		  data-is-logged-in="{{ 'true' if is_logged_in else 'false' }}"
		  data-automatic-logout-url="{{ url_for('automatic_logout') }}">

		<!-- ZENTRALER FLASH-MESSAGE CONTAINER -->
		<div id="flash-container">
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for category, message in messages %}
						{% if category == 'permanent' %}
						<div class="permanent-message" id="permanent-flash">
							<div class="message-content">{{ message }}</div>
							<button class="close-btn" onclick="closePermanentMessage()">&times;</button>
						</div>
						{% else %}
						<div class="{% if category == 'error' %}error-message{% elif category == 'info' %}info-message{% else %}success-message{% endif %}">
							{{ message }}
							<div class="custom-progress-bar"></div>
						</div>
						{% endif %}
					{% endfor %}
				{% endif %}
			{% endwith %}
		</div>
		
		{%block body%}

		{% endblock %}

		<!-- Socket.io Script am Ende des body für bessere Ladeleistung -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
		
		<script>
			// Globale Fehlerbehandlung für AJAX-Antworten
			function handleAjaxError(response) {
				if (response.redirect) {
					window.location.href = response.redirect;
					return true;
				}
				if (response.error) {
					createFlashMessage(response.error, 'error');
					return true;
				}
				return false;
			}

			// AJAX-Fehlerbehandlung für Fetch-API
			function handleFetchError(error) {
				console.error('Fetch error:', error);
				createFlashMessage('Ein Netzwerkfehler ist aufgetreten. Bitte versuche es erneut.', 'error');
			}

			// Globale Funktion zum Abspielen von Sounds
			function playSound(soundId) {
				try {
					// Sound-Instanz dynamisch erstellen
					const sound = new Audio("{{ url_for('static', filename='sounds/button_klick_1.mp3') }}");
					sound.volume = 1.0;
					sound.play().catch(e => console.log("Sound play failed:", e));
				} catch (e) {
					console.error("Sound error:", e);
				}
			}
			// neu
			// Sound-Event für alle Buttons
			document.addEventListener('DOMContentLoaded', () => {
				document.querySelectorAll('.sound-button').forEach(el => {
					el.addEventListener('click', () => {
						playSound('clickSound');
					});
				});
			});

			// Funktion für permanente Nachrichten (aus index.html)
			function closePermanentMessage() {
				const permanentMessage = document.getElementById('permanent-flash');
				if (permanentMessage) {
					permanentMessage.style.opacity = '0';
					permanentMessage.style.transition = 'opacity 0.5s ease';
					
					setTimeout(() => {
						if (permanentMessage.parentNode) {
							permanentMessage.parentNode.removeChild(permanentMessage);
						}
					}, 500);
				}
			}

			// Globale Flash-Message Funktion (für ranking.html, homepage.html, etc.)
			function createFlashMessage(text, type = 'info') {
				const flashContainer = document.getElementById('flash-container');
				if (!flashContainer) return;
				
				// Lösche alle vorhandenen Nachrichten (außer permanent)
				const messages = flashContainer.querySelectorAll('.error-message, .success-message, .info-message');
				messages.forEach(msg => {
					if (!msg.closest('.permanent-message')) {
						msg.remove();
					}
				});
				
				// Neue Nachricht erstellen
				const messageDiv = document.createElement('div');
				messageDiv.className = `${type === 'error' ? 'error-message' : 'info-message'}`;
				messageDiv.textContent = text;
				
				// Fortschrittsbalken hinzufügen
				const progressBar = document.createElement('div');
				progressBar.className = 'custom-progress-bar';
				messageDiv.appendChild(progressBar);
				
				// Nachricht in den Container einfügen
				flashContainer.appendChild(messageDiv);
				
				// Nachricht nach 5 Sekunden entfernen
				setTimeout(() => {
					messageDiv.style.animation = 'fadeOut 0.5s forwards';
					setTimeout(() => {
						if (flashContainer.contains(messageDiv)) {
							flashContainer.removeChild(messageDiv);
						}
					}, 500);
				}, 5000);
			}

			// Inaktivitäts-Timer (nur für eingeloggte Benutzer)
			document.addEventListener('DOMContentLoaded', function() {
				// Werte aus den Datenattributen des Body-Elements lesen
				const body = document.body;
				const isLoggedIn = body.getAttribute('data-is-logged-in') === 'true';
				const automaticLogoutUrl = body.getAttribute('data-automatic-logout-url');
				
				if (isLoggedIn) {
					let inactivityTimer;
					let warningTimer;
					const warningTime = 30 * 60 * 1000; // 30 Minuten
					const logoutTime = 35 * 60 * 1000; // 5 (35) Minute nach Warnung (35 Minuten total)
					let warningMessageElement = null;

					function resetInactivityTimer() {
						clearTimeout(inactivityTimer);
						clearTimeout(warningTimer);
						
						// Entferne Warnmeldung, falls vorhanden
						if (warningMessageElement) {
							warningMessageElement.remove();
							warningMessageElement = null;
						}
						
						inactivityTimer = setTimeout(showInactivityWarning, warningTime);
					}

					function showInactivityWarning() {
						// Erstelle Warnmeldung
						warningMessageElement = createFlashMessage('Sie waren 30 Minuten inaktiv. Sie werden in 5 Minuten automatisch abgemeldet.', 'warning');
						
						// Setze Timer für automatischen Logout
						warningTimer = setTimeout(logoutDueToInactivity, logoutTime - warningTime);
					}

					function logoutDueToInactivity() {
						// Sofortige Weiterleitung zur Logout-URL
						window.location.href = automaticLogoutUrl;
					}

					function createFlashMessage(text, type) {
						const flashContainer = document.getElementById('flash-container');
						if (!flashContainer) return null;
						
						// Lösche vorhandene Warnungen
						const existingWarnings = flashContainer.querySelectorAll('.warning-message, .info-message');
						existingWarnings.forEach(warning => warning.remove());
						
						const messageDiv = document.createElement('div');
						messageDiv.className = `${type}-message`;
						messageDiv.textContent = text;
						messageDiv.style.zIndex = '9999'; // Sehr hoher z-index
						
						// Fortschrittsbalken für die Warnung (5 Minute)
						const progressBar = document.createElement('div');
						progressBar.className = 'custom-progress-bar';
						progressBar.style.animation = 'progressBar 300s linear forwards'; // 300 Sekunden
						messageDiv.appendChild(progressBar);
						
						// Nachricht nach 1 Minute entfernen
						setTimeout(() => {
							if (flashContainer.contains(messageDiv)) {
								flashContainer.removeChild(messageDiv);
								warningMessageElement = null;
							}
						}, logoutTime - warningTime);
						
						flashContainer.appendChild(messageDiv);
						return messageDiv;
					}

					// Timer starten
					resetInactivityTimer();
					
					// Event-Listener für Aktivität
					const events = ['mousemove', 'keypress', 'touchstart', 'click', 'scroll'];
					events.forEach(event => {
						document.addEventListener(event, resetInactivityTimer);
					});
				}
			});
		</script>

		<!-- Quiz-Schutz-Script -->
		<script>
		/*
		Kombinierter pageshow-Handler:
		- BFCache-Fall: wenn e.persisted und auf '/', dann serverseitig ausloggen (nutzt vorhandenen /logout endpoint).
		- Quiz-Fall: wenn sessionStorage 'quiz_active' gesetzt ist, leiten wir zur Quizseite mit Exit-Modal.
		*/
		window.addEventListener('pageshow', function(e) {
			try {
				const path = location.pathname || '/';
				const fromBFCache = !!e.persisted;
				const quizActive = sessionStorage.getItem('quiz_active') === '1';

				// 1) BFCache + Index => serverseitig ausloggen
				if (fromBFCache && path === '/') {
					// Nutze deine vorhandene Logout-Route (stopt Timer + session.clear())
					// Alternativ: "/automatic_logout" falls du die andere Route bevorzugst.
					window.location.href = "{{ url_for('logout') }}";
					return; // stoppe weitere Verarbeitung (kein Doppel-Redirect)
				}

				// 2) Aktives Quiz: weiterleiten zur Quiz-Seite (zeigt Exit-Modal)
				if (quizActive) {
					// Falls wir bereits auf der Quiz-/Auswertungsseite sind, nichts tun
					if (path.startsWith('/show_question') || path.startsWith('/evaluate')) {
						return;
					}
					// Sonst zur Quiz-Seite weiterleiten und das Exit-Modal per Query param antriggern
					window.location.href = '/show_question?show_exit_modal=true';
					return;
				}
			} catch (err) {
				console.warn('pageshow combined handler failed', err);
			}
		});
		</script>
	</body>
</html>